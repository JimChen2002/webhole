(this.webpackJsonpwebhole=this.webpackJsonpwebhole||[]).push([[0],{109:function(e,t,n){},110:function(e,t,n){},165:function(e,t,n){},419:function(e,t,n){},421:function(e,t,n){},423:function(e,t,n){},431:function(e,t,n){},432:function(e,t,n){},433:function(e,t,n){},434:function(e,t,n){},435:function(e,t,n){},436:function(e,t,n){},437:function(e,t,n){"use strict";n.r(t);var a=n(0),o=n.n(a),r=n(8),s=n.n(r),i=(n(98),n(1)),c=n(2),l=n(5),u=n(4),p=n(3),h=n(28),d=n(22),m=n(15),f=n(13),_=n(438),v=n(439),b=n(30),g=n.n(b),E=n(46),w=n.n(E),y=n(83),k=n.n(y),O="https://tapi.cmuhole.com/v3/",S=function(){function e(){Object(i.a)(this,e),this.names={},this.current_h=Math.random()}return Object(c.a)(e,[{key:"get",value:function(e){return"\u6d1e\u4e3b"===(e=e.toLowerCase())?["hsl(0,0%,97%)","hsl(0,0%,16%)"]:(this.names[e]||(this.current_h+=.618033988749895,this.current_h%=1,this.names[e]=["hsl(".concat(360*this.current_h,", 50%, 90%)"),"hsl(".concat(360*this.current_h,", 60%, 20%)")]),this.names[e])}}]),e}(),A=/(^|[^\d\u20e3\ufe0e\ufe0f])(#\d{1,7})(?![\d\u20e3\ufe0e\ufe0f])/g,C=/(^|[^A-Za-z])((?:(?:Angry|Baby|Crazy|Diligent|Excited|Fat|Greedy|Hungry|Interesting|Jolly|Kind|Little|Magic|Na\xefve|Old|PKU|Quiet|Rich|Superman|Tough|Undefined|Valuable|Wifeless|Xiangbuchulai|Young|Zombie)\s)?(?:Alice|Bob|Carol|Dave|Eve|Francis|Grace|Hans|Isabella|Jason|Kate|Louis|Margaret|Nathan|Olivia|Paul|Queen|Richard|Susan|Thomas|Uma|Vivian|Winnie|Xander|Yasmine|Zach)|You Win(?: \d+)?|\u6d1e\u4e3b)(?![A-Za-z])/gi,x=/(^|[^.@a-zA-Z0-9_])((?:https?:\/\/)?(?:(?:[\w-]+\.)+[a-zA-Z]{2,3}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d{1,5})?(?:\/[\w~!@#$%^&*()\-_=+[\]{};:,./?|]*)?)(?![a-zA-Z0-9])/gi;function N(e,t){return e=[[null,e]],t.forEach((function(t){var n=Object(f.a)(t,2),a=n[0],o=n[1];e=[].concat.apply([],e.map((function(e){var t=Object(f.a)(e,2),n=t[0],r=t[1];return n?[e]:r.split(o).map((function(e){return o.test(e)?[a,e]:[null,e]})).filter((function(e){var t=Object(f.a)(e,2),n=t[0],a=t[1];return null!==n||a}))})))})),e}var j=n(84),P=n.n(j),T=n(85),R=n.n(T),L=n(86),I=n.n(L);n(109),n(110);function D(e){if(!e.ok)throw Error("\u7f51\u7edc\u9519\u8bef ".concat(e.status," ").concat(e.statusText));return e.text().then((function(e){try{return JSON.parse(e)}catch(t){throw console.error("json parse error"),console.trace(t),console.log(e),new SyntaxError("JSON Parse Error "+e.substr(0,50))}}))}function U(){return"&device=0&v="+encodeURIComponent("v3.0.6-"+2*Math.floor(+new Date/72e5))}var F=n(16),M=n(23);function V(e){return e<10?"0"+e:""+e}function B(e){return"".concat(e.getMonth()+1,"-").concat(V(e.getDate())," ").concat(e.getHours(),":").concat(V(e.getMinutes()),":").concat(V(e.getSeconds()))}var K=I()(R.a);function H(e){var t=new Date(1e3*e.stamp);return o.a.createElement("span",{className:"time-str"},o.a.createElement(P.a,{date:t,formatter:K,title:t.toLocaleString("zh-CN",{timeZone:"Asia/Shanghai",hour12:!1})}),"\xa0",e.short?null:B(t))}function W(e){return o.a.createElement("p",{className:"centered-line title-line aux-margin"},o.a.createElement("span",{className:"black-outline"},e.text))}var G=n(47),q=n.n(G),z=(n(165),n(88)),Y=n.n(z),J=n(48),X=n.n(J),Z=(n(418),n(419),n(420),new Y.a({html:!1,linkify:!1,breaks:!0,inline:!0,highlight:function(e,t){if(t&&X.a.getLanguage(t))try{return'<pre class="hljs"><code>'+X.a.highlight(t,e,!0).value+"</code></pre>"}catch(n){}return'<pre class="hljs"><code>'+Z.utils.escapeHtml(e)+"</code></pre>"}})),$=function(e){return Z.render(e)};function Q(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ee(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:" ",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"gi";return e?new RegExp("(".concat(e.split(t).filter((function(e){return!!e})).map(Q).join("|"),")"),n):/^$/g}function te(e){return o.a.createElement("span",{className:"colored-span",style:{"--coloredspan-bgcolor-light":e.colors[0],"--coloredspan-bgcolor-dark":e.colors[1]}},e.children)}function ne(e){return/^https?:\/\//.test(e)?e:"http://"+e}a.PureComponent;var ae=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(){return Object(i.a)(this,n),t.apply(this,arguments)}return Object(c.a)(n,[{key:"render",value:function(){var e=this.props,t=[{shouldProcessNode:function(e){return"img"===e.name},processNode:function(e,t,n){return o.a.createElement("div",{key:n},"[\u56fe\u7247]")}},{shouldProcessNode:function(e){return/^h[123456]$/.test(e.name)},processNode:function(e,t,n){var a=+e.name[1];a<3&&(a=3);var r="h".concat(a);return o.a.createElement(r,{key:n},t)}},{shouldProcessNode:function(e){return"a"===e.name},processNode:function(e,t,n){return o.a.createElement("a",{href:ne(e.attribs.href),target:"_blank",rel:"noopenner noreferrer",className:"ext-link",key:n},t,o.a.createElement("span",{className:"icon icon-new-tab"}))}},{shouldProcessNode:function(e){return"text"===e.type&&(!e.parent||!e.parent.attribs||"application/x-tex"!==e.parent.attribs.encoding)},processNode:function(t,n,a){var r=t.data,s=[["url",x],["pid",A],["nickname",C]];e.search_param&&s.push(["search",ee(e.search_param," ","gi")]);var i=N(r,s);return o.a.createElement(o.a.Fragment,{key:a},i.map((function(t,n){var a=Object(f.a)(t,2),r=a[0],s=a[1];return o.a.createElement("span",{key:n},"url_pid"===r?o.a.createElement("span",{className:"url-pid-link",title:s},"/##"):"url"===r?o.a.createElement("a",{href:ne(s),className:"ext-link",target:"_blank",rel:"noopener noreferrer"},s,o.a.createElement("span",{className:"icon icon-new-tab"})):"pid"===r?o.a.createElement("a",{href:"#"+s,onClick:function(t){t.preventDefault(),e.show_pid(s.substring(1))}},s):"nickname"===r?o.a.createElement(te,{colors:e.color_picker.get(s)},s):"search"===r?o.a.createElement("span",{className:"search-query-highlight"},s):s)})))}},{shouldProcessNode:function(){return!0},processNode:new q.a.ProcessNodeDefinitions(o.a).processDefaultNode}],n=new q.a.Parser;if(e.author&&e.text.match(/^(?:#+ |\$\$|>|```|\t|\s*-|\s*\d+\.)/)){var a=$(e.text);return o.a.createElement(o.a.Fragment,null,e.author,n.parseWithInstructions(a,(function(e){return"script"!==e.type}),t)||"")}var r=e.text;e.author&&(r=e.author+" "+r);var s=$(r);return n.parseWithInstructions(s,(function(e){return"script"!==e.type}),t)||null}}]),n}(a.Component);window.TEXTAREA_BACKUP={};var oe=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={text:""},a.on_change_bound=a.on_change.bind(Object(l.a)(a)),a.on_keydown_bound=a.on_keydown.bind(Object(l.a)(a)),a.clear=a.clear.bind(Object(l.a)(a)),a.area_ref=o.a.createRef(),a.change_callback=e.on_change||function(){},a.submit_callback=e.on_submit||function(){},a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){var e=this;this.setState({text:window.TEXTAREA_BACKUP[this.props.id]||""},(function(){e.change_callback(e.state.text)}))}},{key:"componentWillUnmount",value:function(){window.TEXTAREA_BACKUP[this.props.id]=this.state.text,this.change_callback(this.state.text)}},{key:"on_change",value:function(e){this.setState({text:e.target.value}),this.change_callback(e.target.value)}},{key:"on_keydown",value:function(e){"Enter"===e.key&&e.ctrlKey&&!e.altKey&&(e.preventDefault(),this.submit_callback())}},{key:"clear",value:function(){this.setState({text:""})}},{key:"set",value:function(e){this.change_callback(e),this.setState({text:e})}},{key:"get",value:function(){return this.state.text}},{key:"focus",value:function(){this.area_ref.current.focus()}},{key:"render",value:function(){return o.a.createElement("textarea",{ref:this.area_ref,onChange:this.on_change_bound,value:this.state.text,onKeyDown:this.on_keydown_bound})}}]),n}(a.Component),re=null;function se(){var e=/iPhone|iPad|iPod/i.test(window.navigator.userAgent);return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone?null:e?navigator.standalone?null:o.a.createElement("div",{className:"box promotion-bar"},o.a.createElement("span",{className:"icon icon-about"}),"\xa0 \u7528 Safari \u628a\u6811\u6d1e ",o.a.createElement("b",null,"\u6dfb\u52a0\u5230\u4e3b\u5c4f\u5e55")," \u66f4\u597d\u7528"):re?o.a.createElement("div",{className:"box promotion-bar"},o.a.createElement("span",{className:"icon icon-about"}),"\xa0 \u628a\u7f51\u9875\u7248\u6811\u6d1e"," ",o.a.createElement("b",null,o.a.createElement("a",{onClick:function(){re&&re.prompt()}},"\u5b89\u88c5\u5230\u684c\u9762"))," ","\u66f4\u597d\u7528"):null}function ie(){var e=/Chrome\/(\d+)/.exec(navigator.userAgent);return e=e?e[1]:0,/MicroMessenger\/|QQ\//.test(navigator.userAgent)?o.a.createElement("div",{className:"box box-tip box-warning"},o.a.createElement("b",null,"\u60a8\u6b63\u5728\u4f7f\u7528 QQ/\u5fae\u4fe1 \u5185\u5d4c\u6d4f\u89c8\u5668"),o.a.createElement("br",null),"\u5efa\u8bae\u4f7f\u7528\u7cfb\u7edf\u6d4f\u89c8\u5668\u6253\u5f00\uff0c\u5426\u5219\u53ef\u80fd\u51fa\u73b0\u517c\u5bb9\u95ee\u9898"):/Edge\/1/.test(navigator.userAgent)?o.a.createElement("div",{className:"box box-tip box-warning"},o.a.createElement("b",null,"\u60a8\u6b63\u5728\u4f7f\u7528\u65e7\u7248 Microsoft Edge"),o.a.createElement("br",null),"\u5efa\u8bae\u4f7f\u7528\u65b0\u7248 Edge\uff0c\u5426\u5219\u53ef\u80fd\u51fa\u73b0\u517c\u5bb9\u95ee\u9898"):e>1&&e<57?o.a.createElement("div",{className:"box box-tip box-warning"},o.a.createElement("b",null,"\u60a8\u6b63\u5728\u4f7f\u7528\u53e4\u8001\u7684 Chrome ",e),o.a.createElement("br",null),"\u5efa\u8bae\u4f7f\u7528\u65b0\u7248\u6d4f\u89c8\u5668\uff0c\u5426\u5219\u53ef\u80fd\u51fa\u73b0\u517c\u5bb9\u95ee\u9898"):null}window.addEventListener("beforeinstallprompt",(function(e){console.log("pwa: received before install prompt"),re=e}));var ce=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={moved:!0,init_y:0,init_x:0},a.on_begin_bound=a.on_begin.bind(Object(l.a)(a)),a.on_move_bound=a.on_move.bind(Object(l.a)(a)),a.on_end_bound=a.on_end.bind(Object(l.a)(a)),a.MOVE_THRESHOLD=3,a.last_fire=0,a.popup_anchor=document.getElementById("img_viewer"),a}return Object(c.a)(n,[{key:"on_begin",value:function(e){this.setState({moved:!1,init_y:(e.touches?e.touches[0]:e).screenY,init_x:(e.touches?e.touches[0]:e).screenX})}},{key:"on_move",value:function(e){this.state.moved||Math.abs((e.touches?e.touches[0]:e).screenY-this.state.init_y)+Math.abs((e.touches?e.touches[0]:e).screenX-this.state.init_x)>this.MOVE_THRESHOLD&&this.setState({moved:!0})}},{key:"on_end",value:function(e){this.state.moved||this.do_callback(e),this.setState({moved:!0})}},{key:"do_callback",value:function(e){this.last_fire+100>+new Date||this.popup_anchor&&0!==this.popup_anchor.children.length||(this.last_fire=+new Date,this.props.callback(e))}},{key:"render",value:function(){return o.a.createElement("div",{onTouchStart:this.on_begin_bound,onMouseDown:this.on_begin_bound,onTouchMove:this.on_move_bound,onMouseMove:this.on_move_bound,onClick:this.on_end_bound},this.props.children)}}]),n}(a.PureComponent);n(421);function le(e,t,n,a){a=a||!1,e.addEventListener?e.addEventListener(t,n,a):e.attachEvent&&e.attachEvent("on".concat(t),(function(t){n.call(e,t||window.event)}))}function ue(e,t,n,a){a=a||!1,e.removeEventListener?e.removeEventListener(t,n,a):e.detachEvent&&e.detachEvent("on".concat(t),n)}var pe=function(e){if(!(e instanceof HTMLElement))return document.documentElement;for(var t="absolute"===e.style.position,n=/(scroll|auto)/,a=e;a;){if(!a.parentNode)return e.ownerDocument||document.documentElement;var o=window.getComputedStyle(a),r=o.position,s=o.overflow,i=o["overflow-x"],c=o["overflow-y"];if("static"===r&&t)a=a.parentNode;else{if(n.test(s)&&n.test(i)&&n.test(c))return a;a=a.parentNode}}return e.ownerDocument||e.documentElement||document.documentElement};var he=0,de=0,me="data-lazyload-listened",fe=[],_e=[],ve=!1;try{var be=Object.defineProperty({},"passive",{get:function(){ve=!0}});window.addEventListener("test",null,be)}catch(Kt){}var ge,Ee=!!ve&&{capture:!1,passive:!0},we=function(e){var t=s.a.findDOMNode(e);if(t instanceof HTMLElement){var n=pe(t);(e.props.overflow&&n!==t.ownerDocument&&n!==document&&n!==document.documentElement?function(e,t){var n,a,o=s.a.findDOMNode(e);try{var r=t.getBoundingClientRect();n=r.top,a=r.height}catch(Kt){n=he,a=de}var i,c,l=window.innerHeight||document.documentElement.clientHeight,u=Math.max(n,0),p=Math.min(l,n+a)-u;try{var h=o.getBoundingClientRect();i=h.top,c=h.height}catch(Kt){i=he,c=de}var d=i-u,m=Array.isArray(e.props.offset)?e.props.offset:[e.props.offset,e.props.offset];return d-m[0]<=p&&d+c+m[1]>=0}(e,n):function(e){var t,n,a=s.a.findDOMNode(e);if(!(a.offsetWidth||a.offsetHeight||a.getClientRects().length))return!1;try{var o=a.getBoundingClientRect();t=o.top,n=o.height}catch(Kt){t=he,n=de}var r=window.innerHeight||document.documentElement.clientHeight,i=Array.isArray(e.props.offset)?e.props.offset:[e.props.offset,e.props.offset];return t-i[0]<=r&&t+n+i[1]>=0}(e))?e.state.visible&&!e.state.hidden||(e.props.once&&_e.push(e),e.setState({visible:!0,hidden:!1})):e.props.once||(e.props.unmountIfInvisible?!0===e.visible&&e.setState({visible:!1}):e.props.hiddenIfInvisible&&!1===e.state.hidden&&e.setState({hidden:!0}))}},ye=function(){for(var e=0;e<fe.length;++e){var t=fe[e];we(t)}_e.forEach((function(e){var t=fe.indexOf(e);-1!==t&&fe.splice(t,1)})),_e=[]},ke=null,Oe=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={visible:!1,hidden:!1},a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){var e=window,t=this.props.scrollContainer;t&&"string"===typeof t&&(e=e.document.querySelector(t));var n=void 0!==this.props.debounce&&"throttle"===ge||"debounce"===ge&&void 0===this.props.debounce;if(n&&(ue(e,"scroll",ke,Ee),ue(window,"resize",ke,Ee),ke=null),ke||(void 0!==this.props.debounce?(ke=function(e,t,n){var a,o,r,s,i,c=function c(){var l=+new Date-s;l<t&&l>=0?a=setTimeout(c,t-l):(a=null,n||(i=e.apply(r,o),a||(r=null,o=null)))};return function(){r=this,o=arguments,s=+new Date;var l=n&&!a;return a||(a=setTimeout(c,t)),l&&(i=e.apply(r,o),r=null,o=null),i}}(ye,"number"===typeof this.props.debounce?this.props.debounce:300),ge="debounce"):void 0!==this.props.throttle?(ke=function(e,t,n){var a,o;return t||(t=250),function(){var r=n||this,s=+new Date,i=arguments;a&&s<a+t?(clearTimeout(o),o=setTimeout((function(){a=s,e.apply(r,i)}),t)):(a=s,e.apply(r,i))}}(ye,"number"===typeof this.props.throttle?this.props.throttle:300),ge="throttle"):ke=ye),this.props.overflow){var a=pe(s.a.findDOMNode(this));if(a&&"function"===typeof a.getAttribute){var o=+a.getAttribute(me)+1;1===o&&a.addEventListener("scroll",ke,Ee),a.setAttribute(me,o)}}else if(0===fe.length||n){var r=this.props,i=r.scroll,c=r.resize;i&&le(e,"scroll",ke,Ee),c&&le(window,"resize",ke,Ee)}fe.push(this),we(this)}},{key:"componentWillUnmount",value:function(){if(this.props.overflow){var e=pe(s.a.findDOMNode(this));if(e&&"function"===typeof e.getAttribute){var t=+e.getAttribute(me)-1;0===t?(e.removeEventListener("scroll",ke,Ee),e.removeAttribute(me)):e.setAttribute(me,t)}}var n=fe.indexOf(this);-1!==n&&fe.splice(n,1),0===fe.length&&"undefined"!==typeof window&&(ue(window,"resize",ke,Ee),ue(window,"scroll",ke,Ee))}},{key:"render",value:function(){return this.state.visible?this.props.hiddenIfInvisible?this.state.hidden?o.a.createElement("div",{style:{visibility:"hidden"}},this.props.children):o.a.createElement("div",null,this.props.children):this.props.children:this.props.placeholder?this.props.placeholder:o.a.createElement("div",{style:{height:this.props.height},className:"lazyload-placeholder"})}}]),n}(a.PureComponent);Oe.defaultProps={once:!1,offset:0,overflow:!1,resize:!1,scroll:!0,unmountIfInvisible:!1,hiddenIfInvisible:!1};var Se=Oe,Ae=n(6),Ce=n.n(Ae),xe=n(9),Ne=function(){function e(){var t=this;Object(i.a)(this,e),this.db=null,this.added_items_since_maintenance=0,this.encrypt=this.encrypt.bind(this),this.decrypt=this.decrypt.bind(this);var n=indexedDB.open("hole_v2_cache_db",1);n.onerror=console.error.bind(console),n.onupgradeneeded=function(e){console.log("comment cache db upgrade"),e.target.result.createObjectStore("comment",{keyPath:"pid"}).createIndex("last_access","last_access",{unique:!1})},n.onsuccess=function(e){console.log("comment cache db loaded"),t.db=e.target.result,setTimeout(t.maintenance.bind(t),1)}}return Object(c.a)(e,[{key:"encrypt",value:function(e,t){return JSON.stringify(t)}},{key:"decrypt",value:function(e,t){return JSON.parse(t)}},{key:"get",value:function(e,t){var n=this;return e=parseInt(e),new Promise((function(a,o){if(!n.db)return a([null,"fail"]);var r,s;try{var i=n.db.transaction(["comment"],"readwrite");s=i.objectStore("comment"),r=s.get(e)}catch(Kt){console.error(Kt),a([null,"fail"])}r.onsuccess=function(){var o=r.result;if(o&&o.data_str)if(t===o.version){console.log("comment cache hit",e),o.last_access=+new Date,s.put(o);var i=n.decrypt(e,o.data_str);a([i,"hit"])}else console.log("comment cache expired",e,": ver",o.version,"target",t),s.delete(e),a([null,"expired"]);else a([null,"miss"])},r.onerror=function(e){console.warn("comment cache indexeddb open failed"),console.error(e),a([null,"fail"])}}))}},{key:"put",value:function(e,t,n){var a=this;return e=parseInt(e),new Promise((function(o,r){if(!a.db)return o();try{a.db.transaction(["comment"],"readwrite").objectStore("comment").put({pid:e,version:t,data_str:a.encrypt(e,n),last_access:+new Date}),150===++a.added_items_since_maintenance&&setTimeout(a.maintenance.bind(a),1)}catch(Kt){return console.error(Kt),o()}}))}},{key:"delete",value:function(e){var t=this;return e=parseInt(e),new Promise((function(n,a){if(!t.db)return n();var o;try{o=t.db.transaction(["comment"],"readwrite").objectStore("comment").delete(e)}catch(Kt){return console.error(Kt),n()}o.onerror=function(){return console.warn("comment cache delete failed ",e),n()},o.onsuccess=function(){return n()}}))}},{key:"maintenance",value:function(){var e=this;if(this.db){var t=this.db.transaction(["comment"],"readwrite").objectStore("comment"),n=t.count();n.onsuccess=function(){var a=n.result;a>1e3?(console.log("comment cache db maintenance",a),t.index("last_access").openKeyCursor().onsuccess=function(e){var n=e.target.result;n&&(t.delete(n.primaryKey),--a>1e3&&n.continue())}):console.log("comment cache db no need to maintenance",a),e.added_items_since_maintenance=0},n.onerror=console.error.bind(console)}}},{key:"clear",value:function(){if(this.db)try{indexedDB.deleteDatabase("hole_v2_cache_db"),console.log("delete comment cache db")}catch(Kt){console.error(Kt)}}}]),e}();function je(){return window.hole_cache||(window.hole_cache=new Ne),window.hole_cache}function Pe(e){if(!e.ok)throw Error("\u7f51\u7edc\u9519\u8bef ".concat(e.status," ").concat(e.statusText));return e.text().then((function(e){try{return JSON.parse(e)}catch(Kt){throw console.error("json parse error"),console.trace(Kt),console.log(e),new SyntaxError("JSON Parse Error "+e.substr(0,50))}}))}function Te(e){e.forEach((function(e){e.variant={}}))}var Re=function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n,a,o,r=arguments;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],a=!(r.length>2&&void 0!==r[2])||r[2],e.next=4,Pe(t);case 4:if(0===(o=e.sent).code){e.next=15;break}if(!o.msg){e.next=14;break}if(!n){e.next=11;break}alert(o.msg),e.next=12;break;case 11:throw new Error(o.msg);case 12:e.next=15;break;case 14:throw new Error(JSON.stringify(o));case 15:return a&&Te(o.data),e.abrupt("return",o);case 17:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Le={load_replies:function(e,t,n){return e=parseInt(e),fetch(O+"contents/post/detail?pid="+e+U(),{headers:{TOKEN:t}}).then(Pe).then((function(t){if(0!==t.code)throw new Error(t.msg);return je().put(e,t.post.updated_at,t),t.post.variant={},t.data=t.data.map((function(e){return e._display_color=n.get(e.name),e.variant={},e})),t}))},load_replies_with_cache:function(e,t,n,a){return e=parseInt(e),je().get(e,a).then((function(a){var o=Object(f.a)(a,2),r=o[0],s=o[1];return r?(r.post.variant={},r.data=r.data.map((function(e){return e._display_color=n.get(e.name),e.variant={},e})),r):Le.load_replies(e,t,n).then((function(e){return"expired"===s&&(e.post.variant.new_reply=!0),e}))}))},set_attention:function(){var e=Object(xe.a)(Ce.a.mark((function e(t,n,a){var o,r;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(o=new URLSearchParams).append("pid",t),o.append("switch",n?"1":"0"),e.next=5,fetch(O+"edit/attention?"+U(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",TOKEN:a},body:o});case 5:return r=e.sent,je().delete(t),e.abrupt("return",Re(r,!0,!1));case 8:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),report:function(e,t,n,a,o){if("post"!==e&&"comment"!==e)throw Error("bad type");var r=new URLSearchParams;return r.append("id",t),r.append("reason",a),r.append("type",n),fetch(O+"edit/report/"+e+"?"+U(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",TOKEN:o},body:r}).then(Pe).then((function(e){if(0!==e.code)throw new Error(e.msg);return e}))},get_list:function(){var e=Object(xe.a)(Ce.a.mark((function e(t,n){var a;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(O+"contents/post/list?page="+t+U(),{headers:{TOKEN:n}});case 2:return a=e.sent,e.abrupt("return",Re(a));case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),get_search:function(){var e=Object(xe.a)(Ce.a.mark((function e(t,n,a){var o,r,s=arguments;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=s.length>3&&void 0!==s[3]&&s[3],console.log(!0===o?"/attentions":""),e.next=4,fetch(O+"contents/search"+(!0===o?"/attentions":"")+"?pagesize=50&page="+t+"&keywords="+encodeURIComponent(n)+U(),{headers:{TOKEN:a}});case 4:return r=e.sent,e.abrupt("return",Re(r));case 6:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),get_attention:function(){var e=Object(xe.a)(Ce.a.mark((function e(t,n){var a;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(O+"contents/post/attentions?page="+t+U(),{headers:{TOKEN:n}});case 2:return a=e.sent,e.abrupt("return",Re(a));case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()},Ie=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={loading_status:"idle",msg:[]},a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){this.load()}},{key:"load",value:function(){var e=this;"loading"!==this.state.loading_status&&this.setState({loading_status:"loading"},(function(){fetch(O+"contents/system_msg?"+U(),{headers:{TOKEN:e.props.token}}).then(Pe).then((function(t){if(0!==t.code)throw new Error(t.msg);e.setState({loading_status:"done",msg:t.data})})).catch((function(t){console.error(t),alert(""+t),e.setState({loading_status:"failed"})}))}))}},{key:"render",value:function(){var e=this;return"loading"===this.state.loading_status?o.a.createElement("p",{className:"box box-tip"},"\u52a0\u8f7d\u4e2d\u2026\u2026"):"failed"===this.state.loading_status?o.a.createElement("div",{className:"box box-tip"},o.a.createElement("a",{onClick:function(){e.load()}},"\u91cd\u65b0\u52a0\u8f7d")):"done"===this.state.loading_status?this.state.msg.map((function(e){return o.a.createElement("div",{className:"box",key:e.timestamp},o.a.createElement("div",{className:"box-header"},o.a.createElement(H,{stamp:e.timestamp,short:!1}),o.a.createElement("b",null,e.title)),o.a.createElement("div",{className:"box-content"},o.a.createElement("pre",null,e.content)))})):null}}]),n}(a.PureComponent),De=n(14),Ue=(n(45),n(18)),Fe=n.n(Ue),Me=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={loading_status:"idle",recaptcha_verified:!1,phase:-1},a.ref={username:o.a.createRef(),email_verification:o.a.createRef(),password:o.a.createRef(),password_confirm:o.a.createRef(),checkbox_terms:o.a.createRef(),checkbox_account:o.a.createRef()},a.popup_anchor=document.getElementById("pkuhelper_login_popup_anchor"),a.popup_anchor||(a.popup_anchor=document.createElement("div"),a.popup_anchor.id="pkuhelper_login_popup_anchor",document.body.appendChild(a.popup_anchor)),a}return Object(c.a)(n,[{key:"next_step",value:function(){if("loading"!==this.state.loading_status)switch(this.state.phase){case-1:this.verify_email("v3",(function(){}));break;case 0:this.do_login(this.props.token_callback);break;case 1:this.new_user_registration(this.props.token_callback);break;case 2:this.old_user_registration(this.props.token_callback);break;case 3:this.need_recaptcha()}}},{key:"valid_registration",value:function(){return this.ref.checkbox_terms.current.checked&&this.ref.checkbox_account.current.checked?this.ref.password.current.value.length<8?(alert("\u5bc6\u7801\u592a\u77ed\uff0c\u81f3\u5c11\u5e94\u5305\u542b8\u4e2a\u5b57\u7b26\uff01"),2):this.ref.password.current.value!==this.ref.password_confirm.current.value?(alert("\u5bc6\u7801\u4e0d\u4e00\u81f4\uff01"),3):0:(alert("\u8bf7\u540c\u610f\u6761\u6b3e\u4e0e\u6761\u4ef6\uff01"),1)}},{key:"sha256",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n,a,o;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(new TextEncoder).encode(t),e.next=3,crypto.subtle.digest("SHA-256",n);case 3:return a=e.sent,o=Array.from(new Uint8Array(a)),e.abrupt("return",o.map((function(e){return("00"+e.toString(16)).slice(-2)})).join(""));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"hashpassword",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sha256(t);case 2:return n=e.sent,e.next=5,this.sha256(n);case 5:return n=e.sent,e.abrupt("return",n);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"verify_email",value:function(e,t){var n=this,a=new URL(location.href).searchParams.get("old_token"),o=this.ref.username.current.value,r=e,s=localStorage.recaptcha,i=new URLSearchParams;Object.entries({email:o,old_token:a,recaptcha_version:r,recaptcha_token:s}).forEach((function(e){return i.append.apply(i,Object(De.a)(e))})),this.setState({loading_status:"loading"},(function(){fetch(O+"security/login/check_email?"+U(),{method:"POST",body:i}).then((function(e){return e.json()})).then((function(e){if(e.code<0)throw new Error(e.msg);n.setState({loading_status:"done",phase:e.code}),3===e.code&&t()})).catch((function(e){alert("\u90ae\u7bb1\u68c0\u9a8c\u5931\u8d25\n"+e),n.setState({loading_status:"done"}),console.error(e)}))}))}},{key:"do_login",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n,a,o,r,s,i=this;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.ref.username.current.value,a=this.ref.password.current.value,e.next=4,this.hashpassword(a);case 4:o=e.sent,r=Fe()(navigator.userAgent).browser.name,s=new URLSearchParams,Object.entries({email:n,password_hashed:o,device_type:0,device_info:r}).forEach((function(e){return s.append.apply(s,Object(De.a)(e))})),this.setState({loading_status:"loading"},(function(){fetch(O+"security/login/login?"+U(),{method:"POST",body:s}).then(D).then((function(e){if(0!==e.code){if(e.msg)throw new Error(e.msg);throw new Error(JSON.stringify(e))}t(e.token),alert("\u767b\u5f55\u6210\u529f"),i.setState({loading_status:"done"}),i.props.on_close()})).catch((function(e){console.error(e),alert("\u767b\u5f55\u5931\u8d25\n"+e),i.setState({loading_status:"done"})}))}));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"new_user_registration",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n,a,o,r,s,i,c=this;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===this.valid_registration()){e.next=2;break}return e.abrupt("return");case 2:return n=this.ref.username.current.value,a=this.ref.email_verification.current.value,o=this.ref.password.current.value,e.next=7,this.hashpassword(o);case 7:r=e.sent,s=Fe()(navigator.userAgent).browser.name,i=new URLSearchParams,Object.entries({email:n,password_hashed:r,device_type:0,device_info:s,valid_code:a}).forEach((function(e){return i.append.apply(i,Object(De.a)(e))})),this.setState({loading_status:"loading"},(function(){fetch(O+"security/login/create_account?"+U(),{method:"POST",body:i}).then(D).then((function(e){if(0!==e.code){if(e.msg)throw new Error(e.msg);throw new Error(JSON.stringify(e))}t(e.token),alert("\u767b\u5f55\u6210\u529f"),c.setState({loading_status:"done"}),c.props.on_close()})).catch((function(e){console.error(e),alert("\u767b\u5f55\u5931\u8d25\n"+e),c.setState({loading_status:"done"})}))}));case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"old_user_registration",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n,a,o,r,s,i,c=this;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===this.valid_registration()){e.next=2;break}return e.abrupt("return");case 2:return n=this.ref.username.current.value,a=new URL(location.href).searchParams.get("old_token"),o=this.ref.password.current.value,e.next=7,this.hashpassword(o);case 7:r=e.sent,s=Fe()(navigator.userAgent).browser.name,i=new URLSearchParams,Object.entries({email:n,password_hashed:r,device_type:0,device_info:s,old_token:a}).forEach((function(e){return i.append.apply(i,Object(De.a)(e))})),this.setState({loading_status:"loading"},(function(){fetch(O+"security/login/create_account?"+U(),{method:"POST",body:i}).then(D).then((function(e){if(0!==e.code){if(e.msg)throw new Error(e.msg);throw new Error(JSON.stringify(e))}t(e.token),alert("\u767b\u5f55\u6210\u529f"),c.setState({loading_status:"done"}),c.props.on_close()})).catch((function(e){console.error(e),alert("\u767b\u5f55\u5931\u8d25\n"+e),c.setState({loading_status:"done"})}))}));case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"need_recaptcha",value:function(){console.log(3)}},{key:"render",value:function(){var e=this;return window.recaptchaOptions={useRecaptchaNet:!0},s.a.createPortal(o.a.createElement(F.b,{reCaptchaKey:"6LeXqV4eAAAAAIVICwPAGAGC3UJIHSotqzisoAD8",useRecaptchaNet:!0},o.a.createElement("div",null,o.a.createElement("div",{className:"treehollow-login-popup-shadow"}),o.a.createElement("div",{className:"treehollow-login-popup margin-popup"},o.a.createElement("p",{style:-1===this.state.phase?{}:{display:"none"}},o.a.createElement("label",null,"Email:\xa0",o.a.createElement("input",{ref:this.ref.username,type:"email",autoFocus:!0,placeholder:"CMU Email Only",onKeyDown:function(t){"Enter"===t.key&&e.next_step()}}))),0===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("label",null,"Password:\xa0",o.a.createElement("input",{ref:this.ref.password,type:"password",autoFocus:!0,onKeyDown:function(t){"Enter"===t.key&&e.next_step()}}))),o.a.createElement("p",null,o.a.createElement("a",{onClick:function(){alert("You can delete and sign up again in the sidebar.")}},"Forget your password?"))),1===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("b",null,"New user sign up")),o.a.createElement("p",null,o.a.createElement("label",null,"Verification code:\xa0",o.a.createElement("input",{ref:this.ref.email_verification,type:"tel",autoFocus:!0})))),2===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("b",null,"Old user sign up"))),(1===this.state.phase||2===this.state.phase)&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("label",null,"Password:\xa0",o.a.createElement("input",{ref:this.ref.password,type:"password"}))),o.a.createElement("p",null,o.a.createElement("label",null,"Enter password again:\xa0",o.a.createElement("input",{ref:this.ref.password_confirm,type:"password",onKeyDown:function(t){"Enter"===t.key&&e.next_step()}})))),3===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("b",null,"Enter verification code:")),o.a.createElement(Be,{callback:function(){e.verify_email("v2",(function(){alert("reCAPTCHA failed")}))}},(function(t){return o.a.createElement("p",null,!e.state.recaptcha_verified&&o.a.createElement(F.a,{onVerify:function(n){e.setState({recaptcha_verified:!0}),console.log(n),localStorage.recaptcha=n,e.verify_email("v3",t)}}))}))),o.a.createElement("p",null,o.a.createElement("button",{onClick:this.next_step.bind(this),disabled:"loading"===this.state.loading_status},"Confirm"),o.a.createElement("button",{onClick:this.props.on_close},"Cancel"))))),this.popup_anchor)}}]),n}(a.Component),Ve=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={popup_show:!1},a.on_popup_bound=a.on_popup.bind(Object(l.a)(a)),a.on_close_bound=a.on_close.bind(Object(l.a)(a)),a}return Object(c.a)(n,[{key:"on_popup",value:function(){this.setState({popup_show:!0})}},{key:"on_close",value:function(){this.setState({popup_show:!1})}},{key:"render",value:function(){return o.a.createElement(o.a.Fragment,null,this.props.children(this.on_popup_bound),this.state.popup_show&&o.a.createElement(Me,{token_callback:this.props.token_callback,on_close:this.on_close_bound}))}}]),n}(a.Component),Be=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e,a){var o;return Object(i.a)(this,n),(o=t.call(this,e,a)).onChange=o.onChange.bind(Object(l.a)(o)),o.state={popup_show:!1},o.on_popup_bound=o.on_popup.bind(Object(l.a)(o)),o.on_close_bound=o.on_close.bind(Object(l.a)(o)),o}return Object(c.a)(n,[{key:"on_popup",value:function(){this.setState({popup_show:!0})}},{key:"on_close",value:function(){this.setState({popup_show:!1})}},{key:"componentDidMount",value:function(){this.captchaRef&&(console.log("started, just a second..."),this.captchaRef.reset(),this.captchaRef.execute())}},{key:"onChange",value:function(e){localStorage.recaptcha=e,this.setState({popup_show:!1}),this.props.callback()}},{key:"render",value:function(){var e=this;return o.a.createElement(o.a.Fragment,null,this.props.children(this.on_popup_bound),this.state.popup_show&&o.a.createElement("div",null,o.a.createElement("div",{className:"treehollow-login-popup-shadow"}),o.a.createElement("div",{className:"treehollow-login-popup"},o.a.createElement("div",{className:"g-recaptcha"},o.a.createElement(M.a,{ref:function(t){e.captchaRef=t},sitekey:"6Lcsq14eAAAAALfT0hhnsiIF7te8ikX8S00L6yz1",onChange:this.onChange})),o.a.createElement("p",null,o.a.createElement("button",{onClick:this.on_close_bound},"\u53d6\u6d88")))))}}]),n}(a.Component),Ke=(n(423),{"https://i.cmuhole.com/CMU_Dream.jpg":"CMU Dream","https://cdn.jsdelivr.net/gh/thuhole/webhole@gh-pages/static/bg/eriri.jpg":"\u5e73\u6210\u8457\u540d\u753b\u5e08","https://cdn.jsdelivr.net/gh/thuhole/webhole@gh-pages/static/bg/yurucamp.jpg":"\u9732\u8425\u5929\u4e0b\u7b2c\u4e00","https://cdn.jsdelivr.net/gh/thuhole/webhole@gh-pages/static/bg/minecraft.jpg":"\u9ea6\u6069\xb7\u5e93\u62c9\u592b\u7279","https://cdn.jsdelivr.net/gh/thuhole/webhole@gh-pages/static/bg/cyberpunk.jpg":"\u8d5b\u535a\u57ce\u5e02","https://cdn.jsdelivr.net/gh/thuhole/webhole@gh-pages/static/bg/bj.jpg":"\u57ce\u5e02\u7684\u661f\u5149","https://cdn.jsdelivr.net/gh/thuhole/webhole@gh-pages/static/bg/sif.jpg":"\u68a6\u5f00\u59cb\u7684\u5730\u65b9"}),He={background_img:"https://i.cmuhole.com/CMU_Dream.jpg",background_color:"#113366",pressure:!1,easter_egg:!0,color_scheme:"default",fold:!0,block_words:[]};function We(){var e,t=Object.assign({},He);try{e=JSON.parse(localStorage.hole_config||"{}")}catch(Kt){alert("\u8bbe\u7f6e\u52a0\u8f7d\u5931\u8d25\uff0c\u5c06\u91cd\u7f6e\u4e3a\u9ed8\u8ba4\u8bbe\u7f6e\uff01\n"+Kt),delete localStorage.hole_config,e={}}Object.keys(e).forEach((function(n){void 0!==t[n]&&(t[n]=e[n])})),console.log("config loaded",t),window.config=t}function Ge(){localStorage.hole_config=JSON.stringify(window.config),We()}function qe(e,t){return void 0===e&&(e=window.config.background_img),void 0===t&&(t=window.config.background_color),{background:"transparent center center",backgroundImage:null===e?"unset":'url("'+encodeURI(e)+'")',backgroundColor:t,backgroundSize:"cover"}}var ze=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={img:window.config.background_img,color:window.config.background_color},a}return Object(c.a)(n,[{key:"save_changes",value:function(){this.props.callback({background_img:this.state.img,background_color:this.state.color})}},{key:"on_select",value:function(e){var t=e.target.value;this.setState({img:"##other"===t?"":"##color"===t?null:t},this.save_changes.bind(this))}},{key:"on_change_img",value:function(e){this.setState({img:e.target.value},this.save_changes.bind(this))}},{key:"on_change_color",value:function(e){this.setState({color:e.target.value},this.save_changes.bind(this))}},{key:"render",value:function(){var e=null===this.state.img?"##color":-1===Object.keys(Ke).indexOf(this.state.img)?"##other":this.state.img;return o.a.createElement("div",null,o.a.createElement("p",null,o.a.createElement("b",null,"\u80cc\u666f\u56fe\u7247\uff1a"),o.a.createElement("select",{className:"config-select",value:e,onChange:this.on_select.bind(this)},Object.keys(Ke).map((function(e){return o.a.createElement("option",{key:e,value:e},Ke[e])})),o.a.createElement("option",{value:"##other"},"\u8f93\u5165\u56fe\u7247\u7f51\u5740\u2026\u2026"),o.a.createElement("option",{value:"##color"},"\u7eaf\u8272\u80cc\u666f\u2026\u2026")),"\xa0",o.a.createElement("small",null,"#background_img"),"\xa0","##other"===e&&o.a.createElement("input",{type:"url",placeholder:"\u56fe\u7247\u7f51\u5740",value:this.state.img,onChange:this.on_change_img.bind(this)}),"##color"===e&&o.a.createElement("input",{type:"color",value:this.state.color,onChange:this.on_change_color.bind(this)})),o.a.createElement("div",{className:"bg-preview",style:qe(this.state.img,this.state.color)}))}}]),n}(a.PureComponent),Ye=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={color_scheme:window.config.color_scheme},a}return Object(c.a)(n,[{key:"save_changes",value:function(){this.props.callback({color_scheme:this.state.color_scheme})}},{key:"on_select",value:function(e){var t=e.target.value;this.setState({color_scheme:t},this.save_changes.bind(this))}},{key:"render",value:function(){return o.a.createElement("div",null,o.a.createElement("p",null,o.a.createElement("b",null,"\u591c\u95f4\u6a21\u5f0f\uff1a"),o.a.createElement("select",{className:"config-select",value:this.state.color_scheme,onChange:this.on_select.bind(this)},o.a.createElement("option",{value:"default"},"\u8ddf\u968f\u7cfb\u7edf"),o.a.createElement("option",{value:"light"},"\u59cb\u7ec8\u6d45\u8272\u6a21\u5f0f"),o.a.createElement("option",{value:"dark"},"\u59cb\u7ec8\u6df1\u8272\u6a21\u5f0f")),"\xa0",o.a.createElement("small",null,"#color_scheme")),o.a.createElement("p",{className:"config-description"},"\u9009\u62e9\u6d45\u8272\u6216\u6df1\u8272\u6a21\u5f0f\uff0c\u6df1\u8272\u6a21\u5f0f\u4e0b\u5c06\u4f1a\u8c03\u6697\u56fe\u7247\u4eae\u5ea6"))}}]),n}(a.PureComponent),Je=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state=Object(m.a)({},e.id,window.config[e.id]),a}return Object(c.a)(n,[{key:"save_changes",value:function(){this.props.callback(Object(m.a)({},this.props.id,this.props.sift(this.state[this.props.id])))}},{key:"on_change",value:function(e){var t=this.props.parse(e.target.value);this.setState(Object(m.a)({},this.props.id,t),this.save_changes.bind(this))}},{key:"render",value:function(){return o.a.createElement("div",null,o.a.createElement("label",null,o.a.createElement("p",null,o.a.createElement("b",null,this.props.name),"\xa0",o.a.createElement("small",null,"#",this.props.id)),o.a.createElement("p",{className:"config-description"},this.props.description),o.a.createElement("textarea",{name:"config-"+this.props.id,id:"config-textarea-".concat(this.props.id),className:"config-textarea",value:this.props.display(this.state[this.props.id]),onChange:this.on_change.bind(this)})))}}]),n}(a.PureComponent),Xe=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={switch:window.config[a.props.id]},a}return Object(c.a)(n,[{key:"on_change",value:function(e){var t=this,n=e.target.checked;this.setState({switch:n},(function(){t.props.callback(Object(m.a)({},t.props.id,n))}))}},{key:"render",value:function(){return o.a.createElement("div",null,o.a.createElement("p",null,o.a.createElement("label",null,o.a.createElement("input",{name:"config-"+this.props.id,type:"checkbox",checked:this.state.switch,onChange:this.on_change.bind(this)}),"\xa0",o.a.createElement("b",null,this.props.name),"\xa0",o.a.createElement("small",null,"#",this.props.id))),o.a.createElement("p",{className:"config-description"},this.props.description))}}]),n}(a.PureComponent),Ze=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).save_changes_bound=a.save_changes.bind(Object(l.a)(a)),a}return Object(c.a)(n,[{key:"save_changes",value:function(e){console.log(e),Object.keys(e).forEach((function(t){window.config[t]=e[t]})),Ge()}},{key:"reset_settings",value:function(){window.confirm("\u91cd\u7f6e\u6240\u6709\u8bbe\u7f6e\uff1f")&&(window.config={},Ge(),window.location.reload())}},{key:"render",value:function(){return o.a.createElement("div",null,o.a.createElement("div",{className:"box config-ui-header"},o.a.createElement("p",null,"\u8fd9\u4e9b\u529f\u80fd\u4ecd\u5728\u6d4b\u8bd5\uff0c\u53ef\u80fd\u4e0d\u7a33\u5b9a\uff08",o.a.createElement("a",{onClick:this.reset_settings.bind(this)},"\u5168\u90e8\u91cd\u7f6e"),"\uff09"),o.a.createElement("p",null,o.a.createElement("b",null,"\u4fee\u6539\u8bbe\u7f6e\u540e"," ",o.a.createElement("a",{onClick:function(){window.location.reload()}},"\u5237\u65b0\u9875\u9762")," ","\u65b9\u53ef\u751f\u6548"))),o.a.createElement("div",{className:"box"},o.a.createElement(ze,{id:"background",callback:this.save_changes_bound}),o.a.createElement("hr",null),o.a.createElement(Ye,{id:"color-scheme",callback:this.save_changes_bound}),o.a.createElement("hr",null),o.a.createElement(Je,{id:"block_words",callback:this.save_changes_bound,name:"\u8bbe\u7f6e\u5c4f\u853d\u8bcd",description:"\u5305\u542b\u5c4f\u853d\u8bcd\u7684\u6811\u6d1e\u4f1a\u88ab\u6298\u53e0\uff0c\u6bcf\u884c\u5199\u4e00\u4e2a\u5c4f\u853d\u8bcd",display:function(e){return e.join("\n")},sift:function(e){return e.filter((function(e){return e}))},parse:function(e){return e.split("\n")}}),o.a.createElement("hr",null),o.a.createElement(Xe,{callback:this.save_changes_bound,id:"pressure",name:"\u5feb\u901f\u8fd4\u56de",description:"\u77ed\u6682\u6309\u4f4f Esc \u952e\u6216\u91cd\u538b\u5c4f\u5e55\uff083D Touch\uff09\u53ef\u4ee5\u5feb\u901f\u8fd4\u56de\u6216\u8005\u5237\u65b0\u6811\u6d1e"}),o.a.createElement("hr",null),o.a.createElement(Xe,{callback:this.save_changes_bound,id:"easter_egg",name:"\u5141\u8bb8\u5f69\u86cb",description:"\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u663e\u793a\u5f69\u86cb"}),o.a.createElement("hr",null),o.a.createElement(Xe,{callback:this.save_changes_bound,id:"fold",name:"\u6298\u53e0\u6811\u6d1e",description:"\u5728\u65f6\u95f4\u7ebf\u4e2d\u6298\u53e0\u53ef\u80fd\u5f15\u8d77\u4e0d\u9002\u7684\u6811\u6d1e"}),localStorage.hide_announcement&&o.a.createElement("div",null,o.a.createElement("hr",null),o.a.createElement("p",null,"\u5df2\u9690\u85cf\u7684\u516c\u544a"),o.a.createElement("div",{className:"box flow-item box-announcement"},o.a.createElement(ae,{text:localStorage.hide_announcement,color_picker:this.color_picker,show_pid:function(){}}),o.a.createElement("a",{onClick:function(){delete localStorage.hide_announcement,alert("\u5df2\u53d6\u6d88\u9690\u85cf\u516c\u544a")}},"[\u53d6\u6d88\u9690\u85cf]"))),o.a.createElement("hr",null),o.a.createElement("p",null,"\u65b0\u529f\u80fd\u5efa\u8bae\u6216\u95ee\u9898\u53cd\u9988\u8bf7\u5728\xa0",o.a.createElement("a",{href:Object({NODE_ENV:"production",PUBLIC_URL:"https://cdn.jsdelivr.net/gh/JimChen2002/webhole@gh-pages-master",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,REACT_APP_BUILD_INFO:"v3.0.6",REACT_APP_VERSION:"3.0.6",REACT_APP_TITLE:"CMU Anonymous Space",REACT_APP_WEBSITE_URL:"cmuhole.com",REACT_APP_RECAPTCHA_V3_KEY:"6LeXqV4eAAAAAIVICwPAGAGC3UJIHSotqzisoAD8",REACT_APP_RECAPTCHA_V2_KEY:"6Lcsq14eAAAAALfT0hhnsiIF7te8ikX8S00L6yz1",REACT_APP_API_ROOT:"https://tapi.cmuhole.com/v3/",REACT_APP_IMG_BASE_URL:"https://i.cmuhole.com/",REACT_APP_IMG_BASE_BAK_URL:"https://i2.cmuhole.com/",REACT_APP_FOLD_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9,\u4e3e\u62a5\u8f83\u591a",REACT_APP_SENDABLE_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9",REACT_APP_REPORTABLE_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002",REACT_APP_CONTACT_EMAIL:"contact@cmuhole.com",REACT_APP_RULES_URL:"https://terms.cmuhole.com/rules.html",REACT_APP_TOS_URL:"https://terms.cmuhole.com/tos.html",REACT_APP_PRIVACY_URL:"https://terms.cmuhole.com/privacy.html",REACT_APP_COPYRIGHT_STRING:"cmuhole"}).REACT_APP_GITHUB_ISSUES_URL,target:"_blank"},"GitHub ",o.a.createElement("span",{className:"icon icon-github"})),"\xa0\u63d0\u51fa\u3002")))}}]),n}(a.PureComponent),$e=n(89),Qe=n.n($e),et=(n(431),function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={loading_status:"idle",recaptcha_verified:!1,phase:-1},a.ref={username:o.a.createRef(),email_verification:o.a.createRef(),nonce:o.a.createRef(),checkbox_account:o.a.createRef()},a.popup_anchor=document.getElementById("pkuhelper_login_popup_anchor"),a.popup_anchor||(a.popup_anchor=document.createElement("div"),a.popup_anchor.id="pkuhelper_login_popup_anchor",document.body.appendChild(a.popup_anchor)),a}return Object(c.a)(n,[{key:"valid_registration",value:function(){return this.ref.checkbox_account.current.checked?0:(alert("\u8bf7\u540c\u610f\u6761\u6b3e\u4e0e\u6761\u4ef6\uff01"),1)}},{key:"next_step",value:function(){if("loading"!==this.state.loading_status)switch(this.state.phase){case-1:this.verify_email("v3",(function(){}));break;case 1:this.delete_account();break;case 3:this.need_recaptcha()}}},{key:"verify_email",value:function(e,t){var n=this,a=new URL(location.href).searchParams.get("old_token"),o=this.ref.username.current.value,r=e,s=localStorage.recaptcha,i=new URLSearchParams;Object.entries({email:o,old_token:a,recaptcha_version:r,recaptcha_token:s}).forEach((function(e){return i.append.apply(i,Object(De.a)(e))})),this.setState({loading_status:"loading"},(function(){fetch(O+"security/login/check_email_unregister?"+U(),{method:"POST",body:i}).then((function(e){return e.json()})).then((function(e){if(e.code<0)throw new Error(e.msg);n.setState({loading_status:"done",phase:e.code}),3===e.code&&t()})).catch((function(e){alert("\u90ae\u7bb1\u68c0\u9a8c\u5931\u8d25\n"+e),n.setState({loading_status:"done"}),console.error(e)}))}))}},{key:"delete_account",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(){var t,n,a,o,r=this;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===this.valid_registration()){e.next=2;break}return e.abrupt("return");case 2:t=this.ref.username.current.value,n=this.ref.email_verification.current.value,a=this.ref.nonce.current.value,o=new URLSearchParams,Object.entries({email:t,nonce:a,valid_code:n}).forEach((function(e){return o.append.apply(o,Object(De.a)(e))})),this.setState({loading_status:"loading"},(function(){fetch(O+"security/login/unregister?"+U(),{method:"POST",body:o}).then(D).then((function(e){if(0!==e.code){if(e.msg)throw new Error(e.msg);throw new Error(JSON.stringify(e))}alert("\u6ce8\u9500\u8d26\u6237\u6210\u529f"),r.setState({loading_status:"done"}),r.props.on_close()})).catch((function(e){console.error(e),alert("\u5931\u8d25\n"+e),r.setState({loading_status:"done"})}))}));case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"need_recaptcha",value:function(){console.log(3)}},{key:"render",value:function(){var e=this;return window.recaptchaOptions={useRecaptchaNet:!0},s.a.createPortal(o.a.createElement(F.b,{reCaptchaKey:"6LeXqV4eAAAAAIVICwPAGAGC3UJIHSotqzisoAD8",useRecaptchaNet:!0},o.a.createElement("div",null,o.a.createElement("div",{className:"treehollow-login-popup-shadow"}),o.a.createElement("div",{className:"treehollow-login-popup margin-popup"},-1===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("b",null,"\u8f93\u5165\u90ae\u7bb1\u6765\u6ce8\u9500\u8d26\u6237/\u627e\u56de\u5bc6\u7801"))),o.a.createElement("p",{style:-1===this.state.phase?{}:{display:"none"}},o.a.createElement("label",null,"\u90ae\u7bb1\xa0",o.a.createElement("input",{ref:this.ref.username,type:"email",autoFocus:!0,defaultValue:"@mails.tsinghua.edu.cn",onKeyDown:function(t){"Enter"===t.key&&e.next_step()}}))),1===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("b",null,"CMU Anonymous Space"," \u6ce8\u9500\u8d26\u6237")),o.a.createElement("p",null,o.a.createElement("label",null,"\u90ae\u7bb1\u9a8c\u8bc1\u7801\xa0",o.a.createElement("input",{ref:this.ref.email_verification,type:"tel",autoFocus:!0}))),o.a.createElement("p",null,"Nonce\uff1a\xa0",o.a.createElement("label",null,o.a.createElement("input",{ref:this.ref.nonce,autoFocus:!0}))),o.a.createElement("p",null,"\u6ce8\uff1aNonce\u662f\u6ce8\u518c\u6811\u6d1e\u65f6\u6b22\u8fce\u90ae\u4ef6\u4e2d\u7684\u201c\u627e\u56de\u5bc6\u7801\u53e3\u4ee4\u201d\uff0c\u5f62\u5982xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\u3002"),o.a.createElement("p",null,o.a.createElement("label",null,o.a.createElement("input",{type:"checkbox",ref:this.ref.checkbox_account}),"\u6211\u5df2\u7ecf\u4e86\u89e3\u4e86\u6ce8\u9500\u8d26\u6237\u540e\uff0c\u539f\u8d26\u6237\u7684\u53d1\u5e16\u3001\u8bc4\u8bba\u5c06\u4fdd\u7559\uff1b\u6ce8\u9500\u8d26\u6237\u540e\u53ef\u4ee5\u91cd\u65b0\u6ce8\u518c\u6811\u6d1e\uff0c\u4f46\u539f\u8d26\u6237\u7684\u5173\u6ce8\u5217\u8868\u3001\u8bc4\u8bba\u533a\u6635\u79f0\u7b49\u5173\u8054\u6570\u636e\u5c06\u4e22\u5931\u3002"))),3===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("b",null,"\u8f93\u5165\u9a8c\u8bc1\u7801 ","CMU Anonymous Space")),o.a.createElement(Be,{callback:function(){e.verify_email("v2",(function(){alert("reCAPTCHA\u98ce\u63a7\u7cfb\u7edf\u6821\u9a8c\u5931\u8d25")}))}},(function(t){return o.a.createElement("p",null,!e.state.recaptcha_verified&&o.a.createElement(F.a,{onVerify:function(n){e.setState({recaptcha_verified:!0}),console.log(n),localStorage.recaptcha=n,e.verify_email("v3",t)}}))}))),o.a.createElement("p",null,o.a.createElement("button",{onClick:this.next_step.bind(this),disabled:"loading"===this.state.loading_status},"\u4e0b\u4e00\u6b65"),o.a.createElement("button",{onClick:this.props.on_close},"\u53d6\u6d88"))))),this.popup_anchor)}}]),n}(a.Component)),tt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={popup_show:!1},a.on_popup_bound=a.on_popup.bind(Object(l.a)(a)),a.on_close_bound=a.on_close.bind(Object(l.a)(a)),a}return Object(c.a)(n,[{key:"on_popup",value:function(){this.setState({popup_show:!0})}},{key:"on_close",value:function(){this.setState({popup_show:!1})}},{key:"render",value:function(){return o.a.createElement(o.a.Fragment,null,this.props.children(this.on_popup_bound),this.state.popup_show&&o.a.createElement(et,{on_close:this.on_close_bound}))}}]),n}(a.Component),nt=o.a.createContext({value:null,set_value:function(){}});function at(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then((function(e){var t,n=Object(h.a)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;console.log("unregister",a),a.unregister()}}catch(o){n.e(o)}finally{n.f()}})),e&&je().clear(),setTimeout((function(){window.location.reload(!0)}),1e3)}function ot(e){return o.a.createElement("div",null,o.a.createElement(se,null),o.a.createElement(ie,null),o.a.createElement(rt,{show_sidebar:e.show_sidebar}),o.a.createElement("div",{className:"box list-menu"},o.a.createElement("a",{href:"https://terms.cmuhole.com/rules.html",target:"_blank"},o.a.createElement("span",{className:"icon icon-textfile"}),o.a.createElement("label",null,"\u6811\u6d1e\u89c4\u8303")),"\xa0\xa0",o.a.createElement("a",{href:"https://terms.cmuhole.com/tos.html",target:"_blank"},o.a.createElement("span",{className:"icon icon-textfile"}),o.a.createElement("label",null,"\u670d\u52a1\u534f\u8bae")),"\xa0\xa0",o.a.createElement("a",{href:"https://terms.cmuhole.com/privacy.html",target:"_blank"},o.a.createElement("span",{className:"icon icon-textfile"}),o.a.createElement("label",null,"\u9690\u79c1\u653f\u7b56")),o.a.createElement("br",null),o.a.createElement("a",{onClick:function(){e.show_sidebar("\u8bbe\u7f6e",o.a.createElement(Ze,null))}},o.a.createElement("span",{className:"icon icon-settings"}),o.a.createElement("label",null,"\u8bbe\u7f6e")),"\xa0\xa0",o.a.createElement("a",{href:Object({NODE_ENV:"production",PUBLIC_URL:"https://cdn.jsdelivr.net/gh/JimChen2002/webhole@gh-pages-master",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,REACT_APP_BUILD_INFO:"v3.0.6",REACT_APP_VERSION:"3.0.6",REACT_APP_TITLE:"CMU Anonymous Space",REACT_APP_WEBSITE_URL:"cmuhole.com",REACT_APP_RECAPTCHA_V3_KEY:"6LeXqV4eAAAAAIVICwPAGAGC3UJIHSotqzisoAD8",REACT_APP_RECAPTCHA_V2_KEY:"6Lcsq14eAAAAALfT0hhnsiIF7te8ikX8S00L6yz1",REACT_APP_API_ROOT:"https://tapi.cmuhole.com/v3/",REACT_APP_IMG_BASE_URL:"https://i.cmuhole.com/",REACT_APP_IMG_BASE_BAK_URL:"https://i2.cmuhole.com/",REACT_APP_FOLD_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9,\u4e3e\u62a5\u8f83\u591a",REACT_APP_SENDABLE_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9",REACT_APP_REPORTABLE_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002",REACT_APP_CONTACT_EMAIL:"contact@cmuhole.com",REACT_APP_RULES_URL:"https://terms.cmuhole.com/rules.html",REACT_APP_TOS_URL:"https://terms.cmuhole.com/tos.html",REACT_APP_PRIVACY_URL:"https://terms.cmuhole.com/privacy.html",REACT_APP_COPYRIGHT_STRING:"cmuhole"}).REACT_APP_GITHUB_ISSUES_URL,target:"_blank"},o.a.createElement("span",{className:"icon icon-github"}),o.a.createElement("label",null,"\u610f\u89c1\u53cd\u9988")),o.a.createElement("br",null),o.a.createElement(tt,null,(function(e){return o.a.createElement("a",{onClick:e},o.a.createElement("span",{className:"icon icon-refresh"}),o.a.createElement("label",null,"\u6ce8\u9500\u8d26\u6237/\u627e\u56de\u5bc6\u7801"))}))),o.a.createElement("div",{className:"box help-desc-box"},o.a.createElement("p",null,o.a.createElement("a",{onClick:at},"\u5f3a\u5236\u68c0\u67e5\u66f4\u65b0"),"\uff08\u5f53\u524d\u7248\u672c\uff1a\u3010","v3.0.6"," ","production","\u3011 \u4f1a\u81ea\u52a8\u5728\u540e\u53f0\u68c0\u67e5\u66f4\u65b0\u5e76\u5728\u4e0b\u6b21\u8bbf\u95ee\u65f6\u66f4\u65b0\uff09")),o.a.createElement("div",{className:"box help-desc-box"},o.a.createElement("p",null,"\u8054\u7cfb\u6211\u4eec\uff1a","contact@cmuhole.com")),o.a.createElement("div",{className:"box help-desc-box"},o.a.createElement("p",null,"CMU Anonymous Space"," \u7f51\u9875\u7248 by @",Object({NODE_ENV:"production",PUBLIC_URL:"https://cdn.jsdelivr.net/gh/JimChen2002/webhole@gh-pages-master",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,REACT_APP_BUILD_INFO:"v3.0.6",REACT_APP_VERSION:"3.0.6",REACT_APP_TITLE:"CMU Anonymous Space",REACT_APP_WEBSITE_URL:"cmuhole.com",REACT_APP_RECAPTCHA_V3_KEY:"6LeXqV4eAAAAAIVICwPAGAGC3UJIHSotqzisoAD8",REACT_APP_RECAPTCHA_V2_KEY:"6Lcsq14eAAAAALfT0hhnsiIF7te8ikX8S00L6yz1",REACT_APP_API_ROOT:"https://tapi.cmuhole.com/v3/",REACT_APP_IMG_BASE_URL:"https://i.cmuhole.com/",REACT_APP_IMG_BASE_BAK_URL:"https://i2.cmuhole.com/",REACT_APP_FOLD_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9,\u4e3e\u62a5\u8f83\u591a",REACT_APP_SENDABLE_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9",REACT_APP_REPORTABLE_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002",REACT_APP_CONTACT_EMAIL:"contact@cmuhole.com",REACT_APP_RULES_URL:"https://terms.cmuhole.com/rules.html",REACT_APP_TOS_URL:"https://terms.cmuhole.com/tos.html",REACT_APP_PRIVACY_URL:"https://terms.cmuhole.com/privacy.html",REACT_APP_COPYRIGHT_STRING:"cmuhole"}).REACT_APP_GITHUB_USER,"\uff0c \u57fa\u4e8e\xa0",o.a.createElement("a",{href:"https://www.gnu.org/licenses/gpl-3.0.zh-cn.html",target:"_blank"},"GPLv3"),"\xa0\u534f\u8bae\u5728"," ",o.a.createElement("a",{href:Object({NODE_ENV:"production",PUBLIC_URL:"https://cdn.jsdelivr.net/gh/JimChen2002/webhole@gh-pages-master",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,REACT_APP_BUILD_INFO:"v3.0.6",REACT_APP_VERSION:"3.0.6",REACT_APP_TITLE:"CMU Anonymous Space",REACT_APP_WEBSITE_URL:"cmuhole.com",REACT_APP_RECAPTCHA_V3_KEY:"6LeXqV4eAAAAAIVICwPAGAGC3UJIHSotqzisoAD8",REACT_APP_RECAPTCHA_V2_KEY:"6Lcsq14eAAAAALfT0hhnsiIF7te8ikX8S00L6yz1",REACT_APP_API_ROOT:"https://tapi.cmuhole.com/v3/",REACT_APP_IMG_BASE_URL:"https://i.cmuhole.com/",REACT_APP_IMG_BASE_BAK_URL:"https://i2.cmuhole.com/",REACT_APP_FOLD_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9,\u4e3e\u62a5\u8f83\u591a",REACT_APP_SENDABLE_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9",REACT_APP_REPORTABLE_TAGS:"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002",REACT_APP_CONTACT_EMAIL:"contact@cmuhole.com",REACT_APP_RULES_URL:"https://terms.cmuhole.com/rules.html",REACT_APP_TOS_URL:"https://terms.cmuhole.com/tos.html",REACT_APP_PRIVACY_URL:"https://terms.cmuhole.com/privacy.html",REACT_APP_COPYRIGHT_STRING:"cmuhole"}).REACT_APP_GITHUB_WEB_URL,target:"_blank"},"GitHub")," ","\u5f00\u6e90"),o.a.createElement("p",null,"CMU Anonymous Space"," \u7f51\u9875\u7248\u7684\u8bde\u751f\u79bb\u4e0d\u5f00\xa0",o.a.createElement("a",{href:"https://github.com/pkuhelper-web/webhole",target:"_blank",rel:"noopener"},"P\u5927\u6811\u6d1e\u7f51\u9875\u7248 by @xmcp"),"\u3001",o.a.createElement("a",{href:"https://reactjs.org/",target:"_blank",rel:"noopener"},"React"),"\u3001",o.a.createElement("a",{href:"https://icomoon.io/#icons",target:"_blank",rel:"noopener"},"IcoMoon"),"\xa0\u7b49\u5f00\u6e90\u9879\u76ee"),o.a.createElement("p",null,"This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version."),o.a.createElement("p",null,"This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\xa0",o.a.createElement("a",{href:"https://www.gnu.org/licenses/gpl-3.0.zh-cn.html",target:"_blank"},"GNU General Public License"),"\xa0for more details.")))}var rt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(){return Object(i.a)(this,n),t.apply(this,arguments)}return Object(c.a)(n,[{key:"render",value:function(){var e=this;return o.a.createElement(nt.Consumer,null,(function(t){return o.a.createElement("div",null,o.a.createElement("div",{className:"login-form box"},t.value?o.a.createElement("div",null,o.a.createElement("p",null,o.a.createElement("b",null,"\u60a8\u5df2\u767b\u5f55\u3002"),o.a.createElement("button",{type:"button",onClick:function(){fetch(O+"security/logout?"+U(),{method:"POST",headers:{TOKEN:t.value}}).then(Pe).then((function(e){if(0!==e.code)throw new Error(e.msg);t.set_value(null)})).catch((function(e){console.error(e),alert(""+e),t.set_value(null)}))}},o.a.createElement("span",{className:"icon icon-logout"})," \u6ce8\u9500"),o.a.createElement("br",null)),o.a.createElement("p",null,o.a.createElement("a",{onClick:function(){e.props.show_sidebar("\u7cfb\u7edf\u6d88\u606f",o.a.createElement(Ie,{token:t.value}))}},"\u67e5\u770b\u7cfb\u7edf\u6d88\u606f"),o.a.createElement("br",null),"\u5f53\u60a8\u53d1\u9001\u7684\u5185\u5bb9\u8fdd\u89c4\u65f6\uff0c\u6211\u4eec\u5c06\u7528\u7cfb\u7edf\u6d88\u606f\u63d0\u793a\u60a8")):o.a.createElement(Ve,{token_callback:t.set_value},(function(e){return o.a.createElement("div",null,o.a.createElement("p",null,o.a.createElement("button",{type:"button",onClick:e},o.a.createElement("span",{className:"icon icon-login"}),"\xa0\u767b\u5f55")),o.a.createElement("p",null,o.a.createElement("small",null,"CMU Anonymous Space","\u9762\u5411T\u5927\u5b66\u751f\uff0c\u901a\u8fc7T\u5927\u90ae\u7bb1\u9a8c\u8bc1\u60a8\u7684\u8eab\u4efd\u5e76\u63d0\u4f9b\u670d\u52a1\u3002")))}))))}))}}]),n}(a.Component),st=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).onChangeCheckAndSend=a.checkAndSend.bind(Object(l.a)(a)),a}return Object(c.a)(n,[{key:"checkAndSend",value:function(e){var t=this;return function(n){(0,t.props.sendVoteData)(Object(m.a)({},e,n))}}},{key:"render",value:function(){for(var e=this,t=this.props.num,n=[],a=function(t){n.push(o.a.createElement("input",{key:t,maxLength:"15",style:{padding:"0 2px",margin:"2px 2px"},onChange:function(n){e.onChangeCheckAndSend(t+1)(n.target.value)},placeholder:t+1}))},r=0;r<t;r+=1)a(r);return o.a.createElement("div",null,o.a.createElement("hr",null),o.a.createElement("p",null,"\u8bbe\u7f6e2~4\u4e2a\u9009\u9879\uff0c\u6bcf\u9879\u4e0d\u8d85\u8fc715\u5b57\u7b26"),n)}}]),n}(a.Component),it=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={text:"",loading_status:"done",img_tip:null,preview:!1,vote:!1,voteOptionNum:0,voteData:{1:null,2:null,3:null,4:null},tag:"\u53ef\u9009\u6807\u7b7e"},a.img_ref=o.a.createRef(),a.area_ref=a.props.area_ref||o.a.createRef(),a.on_change_bound=a.on_change.bind(Object(l.a)(a)),a.on_img_change_bound=a.on_img_change.bind(Object(l.a)(a)),a.global_keypress_handler_bound=a.global_keypress_handler.bind(Object(l.a)(a)),a.color_picker=new S,a}return Object(c.a)(n,[{key:"global_keypress_handler",value:function(e){"Enter"!==e.code||e.ctrlKey||e.altKey||-1!==["input","textarea"].indexOf(e.target.tagName.toLowerCase())||this.area_ref.current&&(e.preventDefault(),this.area_ref.current.focus())}},{key:"componentDidMount",value:function(){document.addEventListener("keypress",this.global_keypress_handler_bound)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("keypress",this.global_keypress_handler_bound)}},{key:"on_change",value:function(e){this.setState({text:e})}},{key:"do_post",value:function(e,t){var n,a=this,o=new URLSearchParams;if("docomment"===this.props.action?(o.append("pid",this.props.pid),o.append("reply_to_cid",this.props.reply_to_ref.reply_to),n="send/comment?"):n="send/post?",o.append("text",this.state.text),o.append("type",t?"image":"text"),"\u53ef\u9009\u6807\u7b7e"!==this.state.tag&&o.append("tag",this.state.tag),t&&o.append("data",t),this.state.vote){var r=this.state.voteData;Object.keys(r).forEach((function(e){r[e]||delete r[e]})),Object.values(r).map((function(e){o.append("vote_options[]",e)}))}fetch(O+n+U(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",TOKEN:this.props.token},body:o}).then(Pe).then((function(e){if(0!==e.code)throw e.msg&&alert(e.msg),new Error(JSON.stringify(e));a.setState({loading_status:"done",text:"",preview:!1}),a.area_ref.current.clear(),a.props.on_complete()})).catch((function(e){console.error(e),alert("\u53d1\u8868\u5931\u8d25"),a.setState({loading_status:"done"})}))}},{key:"proc_img",value:function(e){return new Promise((function(t,n){function a(e){var t=e.indexOf(";base64,");if(-1===t)throw new Error("img not base64 encoded");return e.substr(t+8)}var o=new FileReader;o.onload=function(e){Qe()(e.target.result,{},(function(e){!function(e){var o=new Image;o.onload=function(){var e=o.width,r=o.height,s=!1;if(e>8e3&&(r=8e3*r/e,e=8e3,s=!0),r>8e3&&(e=8e3*e/r,r=8e3,s=!0),r*e>5e6){var i=Math.sqrt(r*e/5e6);r/=i,e/=i,s=!0}console.log("chosen img size",e,r);var c=document.createElement("canvas"),l=c.getContext("2d");c.width=e,c.height=r,l.drawImage(o,0,0,e,r);for(var u,p,h=.1,d=.9;d-h>=.03;)u=(d+h)/2,p=c.toDataURL("image/jpeg",u),console.log(h,d,"trying quality",u,"size",p.length),p.length<=6e5?h=u:d=u;h>=.101?(console.log("chosen img quality",u),t({img:a(p),quality:u,width:Math.round(e),height:Math.round(r),compressed:s})):n("\u56fe\u7247\u8fc7\u5927\uff0c\u65e0\u6cd5\u4e0a\u4f20")},o.src=e}(e)}))},o.readAsDataURL(e)}))}},{key:"on_img_change",value:function(){var e=this;this.img_ref.current&&this.img_ref.current.files.length?this.setState({img_tip:"\uff08\u6b63\u5728\u5904\u7406\u56fe\u7247\u2026\u2026\uff09"},(function(){e.proc_img(e.img_ref.current.files[0]).then((function(t){e.setState({img_tip:"\uff08".concat(t.compressed?"\u538b\u7f29\u5230":"\u5c3a\u5bf8"," ").concat(t.width,"*").concat(t.height," / ")+"\u8d28\u91cf ".concat(Math.floor(100*t.quality),"% / ").concat(Math.floor(t.img.length/(4/3)/1e3),"KB\uff09")})})).catch((function(t){e.setState({img_tip:"\u56fe\u7247\u65e0\u6548\uff1a".concat(t)})}))})):this.setState({img_tip:null})}},{key:"on_submit",value:function(e){var t=this;e&&e.preventDefault(),"loading"!==this.state.loading_status&&(this.img_ref.current.files.length?(this.setState({loading_status:"processing"}),this.proc_img(this.img_ref.current.files[0]).then((function(e){t.setState({loading_status:"loading"}),t.do_post(t.state.text,e.img)})).catch((function(e){alert(e)}))):(this.setState({loading_status:"loading"}),this.do_post(this.state.text,null)))}},{key:"toggle_preview",value:function(){this.setState({preview:!this.state.preview})}},{key:"addVote",value:function(){var e=this.state.voteOptionNum;e>=4?alert("\u6700\u5927\u652f\u63014\u4e2a\u9009\u9879"):0==e?e=2:e++,this.setState({voteOptionNum:e})}},{key:"render",value:function(){var e=this,t=this.state.vote,n="reply-form box"+(this.state.text?" reply-sticky":""),a="\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9".split(",");return o.a.createElement("form",{onSubmit:this.on_submit.bind(this),className:"dopost"===this.props.action?"post-form box":n},o.a.createElement("div",{className:"post-form-bar"},o.a.createElement("label",null,o.a.createElement("span",{className:"post-upload"},o.a.createElement("span",{className:"icon icon-image"}),"\xa0\u63d2\u5165\u56fe\u7247"),o.a.createElement("input",{ref:this.img_ref,type:"file",accept:"image/*",disabled:"done"!==this.state.loading_status,onChange:this.on_img_change_bound})),"dopost"===this.props.action?t?o.a.createElement("button",{type:"button",onClick:function(){e.addVote()}},o.a.createElement("span",{className:"icon icon-how_to_vote"}),"\xa0\u6dfb\u52a0"):o.a.createElement("button",{type:"button",onClick:function(){e.setState({vote:!0,voteOptionNum:2})}},o.a.createElement("span",{className:"icon icon-how_to_vote"}),"\xa0\u6295\u7968"):o.a.createElement("div",null),this.state.preview?o.a.createElement("button",{type:"button",onClick:function(){e.toggle_preview()}},o.a.createElement("span",{className:"icon icon-eye-blocked"}),"\xa0\u7f16\u8f91"):o.a.createElement("button",{type:"button",onClick:function(){e.toggle_preview()}},o.a.createElement("span",{className:"icon icon-eye"}),"\xa0\u9884\u89c8"),"done"!==this.state.loading_status?o.a.createElement("button",{disabled:"disabled"},o.a.createElement("span",{className:"icon icon-loading"}),"\xa0","processing"===this.state.loading_status?"\u5904\u7406":"\u4e0a\u4f20"):o.a.createElement("button",{type:"submit"},o.a.createElement("span",{className:"icon icon-send"}),"\xa0\u53d1\u8868")),!!this.state.img_tip&&o.a.createElement("p",{className:"post-form-img-tip"},o.a.createElement("a",{onClick:function(){e.img_ref.current.value="",e.on_img_change()}},"\u5220\u9664\u56fe\u7247"),this.state.img_tip),this.state.preview?o.a.createElement("div",{className:"dopost"===this.props.action?"post-preview":"reply-preview"},o.a.createElement(ae,{text:this.state.text,color_picker:this.color_picker,show_pid:function(){}})):o.a.createElement(oe,{ref:this.area_ref,id:this.props.pid,on_change:this.on_change_bound,on_submit:this.on_submit.bind(this)}),0!==this.state.voteOptionNum&&o.a.createElement(st,{num:this.state.voteOptionNum,sendVoteData:function(t){var n=e.state.voteData;Object.assign(n,t),e.setState({voteData:n})}}),"dopost"===this.props.action&&o.a.createElement("div",null,o.a.createElement("small",null,"\u53d1\u5e16\u524d\u8bf7\u9605\u8bfb\u5e76\u540c\u610f",o.a.createElement("a",{href:"https://terms.cmuhole.com/rules.html",target:"_blank"},"\u6811\u6d1e\u89c4\u8303"),"\xa0",o.a.createElement("span",{style:{float:"right"}},o.a.createElement("select",{className:"selectCss",onChange:function(t){return e.setState({tag:t.target.value})}},o.a.createElement("option",{className:"selectOption"},"\u53ef\u9009\u6807\u7b7e"),a.map((function(e,t){return o.a.createElement("option",{className:"selectOption",key:t,value:e},"#",e)})))))))}}]),n}(a.Component),ct=n(49),lt=(0,n(100).detect)(),ut=["logs","rep_dels","rep_folds","log_tags","log_dels","rep_recalls","log_unbans","msgs","dels"],pt={a:!0,audio:!0,button:!0},ht=[];window.LATEST_POST_ID=parseInt(localStorage._LATEST_POST_ID,10)||0;var dt=!1,mt=function(e){return o.a.createElement("p",{className:"img"},o.a.createElement("img",{src:"https://i.cmuhole.com/"+e.path,onError:function(t){t.target.src==="https://i.cmuhole.com/"+e.path&&(t.target.src="https://i2.cmuhole.com/"+e.path)},alt:"https://i.cmuhole.com/"+e.path}))},ft=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={visible:!1},a.popup_anchor=document.getElementById("img_viewer"),a.popup_anchor||(a.popup_anchor=document.createElement("div"),a.popup_anchor.id="img_viewer",document.body.appendChild(a.popup_anchor)),a}return Object(c.a)(n,[{key:"render",value:function(){var e=this;return this.props.in_sidebar?!lt||"ios-webview"!==lt.name&&"chromium-webview"!==lt.name?o.a.createElement("a",{className:"no-underline",href:"https://i.cmuhole.com/"+this.props.url,target:"_blank"},o.a.createElement(mt,{path:this.props.url})):o.a.createElement("div",null,o.a.createElement("a",{className:"no-underline",onClick:function(){e.setState({visible:!0})},target:"_blank"},o.a.createElement(mt,{path:this.props.url})),this.state.visible&&s.a.createPortal(o.a.createElement("div",null,o.a.createElement(k.a,{images:["https://i.cmuhole.com/"+this.props.url],isOpen:!0,onClose:function(){e.setState({visible:!1})}})),this.popup_anchor)):o.a.createElement(mt,{path:this.props.url})}}]),n}(a.PureComponent);function _t(e,t){return function(n){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n=parseInt(n);var r=new S,s="\u6811\u6d1e "+n;e(s,o.a.createElement("div",{className:"box box-tip"},"\u6b63\u5728\u52a0\u8f7d #",n),a?"replace":"push"),Le.load_replies(n,t,r).then((function(n){e(s,o.a.createElement(wt,{key:+new Date,info:n.post,replies:n.data,token:t,show_sidebar:e,color_picker:r}),"replace")})).catch((function(a){console.error(a),e(s,o.a.createElement("div",{className:"box box-tip"},o.a.createElement("p",null,o.a.createElement("a",{onClick:function(){return _t(e,t)(n,!0)}},"\u91cd\u65b0\u52a0\u8f7d")),o.a.createElement("p",null,""+a)),"replace")}))}}var vt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){return Object(i.a)(this,n),t.call(this,e)}return Object(c.a)(n,[{key:"render",value:function(){if(this.props.info.deleted&&dt&&!ut.includes(this.props.search_param))return o.a.createElement(o.a.Fragment,null);var e=this.props,t="["+this.props.info.name+"]",n=this.props.info.text;return o.a.createElement("div",{className:"flow-reply box",style:this.props.info._display_color?{"--box-bgcolor-light":this.props.info._display_color[0],"--box-bgcolor-dark":this.props.info._display_color[1]}:null},o.a.createElement("div",{className:"box-header"},e.header_badges,o.a.createElement("code",{className:"box-id"},"#",this.props.info.cid),"\xa0",null!==this.props.info.tag&&o.a.createElement("span",{className:"box-header-tag"},this.props.info.tag),o.a.createElement(H,{stamp:this.props.info.timestamp,short:!1})),this.props.info.deleted&&o.a.createElement("p",{key:"deleted-hint",className:"flow-variant-warning"},"\uff08\u5df2\u5220\u9664\uff09"),this.props.info.variant.report_widget&&this.props.in_sidebar&&o.a.createElement(bt,{key:"report",info:e.info,is_reply:!0,set_variant:e.set_variant}),o.a.createElement("div",{className:"box-content"},o.a.createElement(ae,{author:t,text:n,search_param:this.props.search_param,color_picker:this.props.color_picker,show_pid:this.props.show_pid}),"image"===this.props.info.type&&o.a.createElement(ft,{in_sidebar:this.props.in_sidebar,url:this.props.info.url})))}}]),n}(a.PureComponent);function bt(e){var t=Object(a.useState)(""),n=Object(f.a)(t,2),r=n[0],s=n[1],i=Object(a.useState)("others"),c=Object(f.a)(i,2),l=c[0],u=c[1];function p(t){var n,a=e.is_reply?"comment":"post",o=e.is_reply?e.info.cid:e.info.pid,s={fold:"\u4e3e\u62a5\u6298\u53e0",delete:"\u5220\u9664",undelete_unban:"\u64a4\u9500\u5220\u9664",delete_ban:"\u5220\u5e16\u7981\u8a00",unban:"\u89e3\u5c01",set_tag:"\u6253tag",report:"\u4e3e\u62a5\u5220\u9664"}[t],i={post:"\u6811\u6d1e",comment:"\u8bc4\u8bba"}[a];switch(t){case"fold":if("select"===(n=r))return;if(!window.confirm("\u786e\u8ba4\u56e0\u4e3a ".concat(n," \u4e3e\u62a5\u6298\u53e0 ").concat(i," #").concat(o," \u5417\uff1f")))return;break;case"set_tag":if("select"===(n=l))return;if("others"===n&&!(n=window.prompt(i+" #"+o+" \u7684tag\uff1a")))return;if(!window.confirm("\u786e\u8ba4\u8bbe\u7f6e".concat(i," #").concat(o,"\u7684tag=").concat(n,"\u5417\uff1f")))return;break;case"report":default:if(!(n=window.prompt("".concat(s)+i+" #"+o+" \u7684\u7406\u7531\uff1a")))return;if(!window.confirm("\u786e\u8ba4\u56e0\u4e3a ".concat(n," \u7684\u7406\u7531 ").concat(s," ").concat(i," #").concat(o," \u5417\uff1f")))return}var c=localStorage.TOKEN;Le.report(a,o,t,n,c).then((function(e){alert("".concat(s,"\u6210\u529f"))})).catch((function(e){alert("\u4e3e\u62a5\u5931\u8d25\uff1a"+e),console.error(e)}))}return o.a.createElement("div",{className:"interactive flow-item-toolbar report-toolbar"},!e.info.permissions.includes("set_tag")&&e.info.permissions.includes("fold")&&o.a.createElement("p",null,o.a.createElement("button",{onClick:function(){return p("fold")}},"\u6298\u53e0"),o.a.createElement("select",{value:r,onChange:function(e){return s(e.target.value)}},o.a.createElement("option",{value:"select"},"\u9009\u62e9\u7406\u7531\u2026\u2026"),"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002".split(",").map((function(e,t){return o.a.createElement("option",{key:t,value:e},"#",e)})))),!e.info.permissions.includes("delete")&&!e.info.permissions.includes("undelete_unban")&&e.info.permissions.includes("report")&&o.a.createElement("p",null,o.a.createElement("button",{onClick:function(){return p("report")}},"\u5220\u9664"),o.a.createElement("span",{className:"report-reason"},"\u8fd9\u6761",e.is_reply?"\u56de\u590d":"\u6811\u6d1e","\u8fdd\u53cd",o.a.createElement("a",{href:"https://terms.cmuhole.com/rules.html",target:"_blank"},"\u793e\u533a\u89c4\u8303"),"\uff0c\u5e94\u88ab\u7981\u6b62")),e.info.permissions.includes("delete")&&o.a.createElement("p",null,o.a.createElement("button",{onClick:function(){return p("delete")}},e.info.permissions.includes("delete_ban")?"\u5220\u9664":"\u64a4\u56de"),o.a.createElement("span",{className:"report-reason"},e.info.permissions.includes("delete_ban")?"\u6ca1\u6709\u7981\u8a00\u60e9\u7f5a\u7684\u5220\u9664\u3002":"\u6811\u6d1e\u53d1\u9001\u4e24\u5206\u949f\u5185\u53ef\u4ee5\u64a4\u56de\uff0c\u4e0d\u4f1a\u7981\u8a00\u3002")),e.info.permissions.includes("undelete_unban")&&o.a.createElement("p",null,o.a.createElement("button",{onClick:function(){return p("undelete_unban")}},"\u64a4\u9500\u5220\u9664"),o.a.createElement("span",{className:"report-reason"},"\u64a4\u9500\u5220\u9664\u5e76\u89e3\u9664\u7981\u8a00\uff08\u5982\u679c\u5b58\u5728\u7981\u8a00\u7684\u8bdd\uff09")),e.info.permissions.includes("delete_ban")&&o.a.createElement("p",null,o.a.createElement("button",{onClick:function(){return p("delete_ban")}},"\u5220\u5e16\u7981\u8a00"),o.a.createElement("span",{className:"report-reason"},"\u5220\u9664\u5e76\u7981\u8a00\u3002\u5220\u9664\u7406\u7531\u4f1a\u901a\u77e5\u7528\u6237\u3002")),e.info.permissions.includes("unban")&&o.a.createElement("p",null,o.a.createElement("button",{onClick:function(){return p("unban")}},"\u89e3\u5c01"),o.a.createElement("span",{className:"report-reason"},"\u89e3\u5c01\uff0c\u4f46\u4e0d\u64a4\u9500\u5220\u9664")),e.info.permissions.includes("set_tag")&&o.a.createElement("p",null,o.a.createElement("button",{onClick:function(){return p("set_tag")}},"\u6253tag"),o.a.createElement("select",{value:l,onChange:function(e){return u(e.target.value)}},o.a.createElement("option",{value:"select"},"\u9009\u62e9\u7406\u7531\u2026\u2026"),"\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002".split(",").map((function(e,t){return o.a.createElement("option",{key:t,value:e},"#",e)})),o.a.createElement("option",{value:""},"\u65e0tag"),o.a.createElement("option",{value:"others"},"\u5176\u4ed6"))))}var gt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={alreadyVote:!1,yourVoteText:"",yourVoteIndex:null,totalCount:0,eachNums:[],loading:!1,vote_data:0},a.sendVoteOption=a.sendVote.bind(Object(l.a)(a)),a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){var e=this.props.voteOptions,t=e.voted,n=e.vote_data,a=0,o=0,r=null,s=[];if(""!==t){for(var i in n)s.push(n[i]),a+=n[i],t===i&&(r=o),o++;this.setState({alreadyVote:!0,yourVoteText:t,yourVoteIndex:r,totalCount:a,eachNums:s})}}},{key:"sendVote",value:function(e){var t=this,n=new URLSearchParams,a=this.props.pid;n.append("pid",a),n.append("option",e),this.setState({loading:!0}),fetch(O+"send/vote?"+U(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",TOKEN:this.props.token},body:n}).then(Pe).then((function(e){if(0!==e.code)throw e.msg&&alert(e.msg),new Error(JSON.stringify(e));var n=e.vote,a=n.voted,o=n.vote_data,r=0,s=0,i=null,c=[];if(""!==a){for(var l in o)c.push(o[l]),r+=o[l],a===l&&(i=s),s++;t.setState({alreadyVote:!0,yourVoteText:a,loading:!1,yourVoteIndex:i,totalCount:r,eachNums:c,vote_data:o}),g.a.publish("VoteDoneClickFreshSideBarFirst",t.props.pid)}})).catch((function(e){console.error(e),alert("\u6295\u7968\u5931\u8d25"),t.setState({alreadyVote:!1,loading:!1})}))}},{key:"render",value:function(){var e=this,t=this.state,n=t.alreadyVote,a=t.eachNums,r=t.yourVoteIndex,s=t.totalCount,i=t.loading,c=this.state.vote_data;0==c&&(c=this.props.voteOptions.vote_data);var l=Object.keys(c),u=[],p=[];return n?l.map((function(e,t){u.push(t==r?o.a.createElement("div",{key:Object(ct.a)(),className:"div-shell",style:{borderColor:"#ffe5d8"}},o.a.createElement("div",{className:"div-background"}),o.a.createElement("div",{className:"div-votedOptionBar",style:{width:a[t]/s*100+"%"}}),o.a.createElement("div",{className:"div-text"},o.a.createElement("p",{className:"p-voteDataShow",style:{left:"0.5em",fontSize:e.length>18?"12px":"14px"}},e),o.a.createElement("p",{className:"p-voteDataShow-right",style:{right:"0.5em",fontSize:a[t]>999?"12px":"14px"}},a[t]),o.a.createElement("span",{className:"liu_area"}))):o.a.createElement("div",{key:Object(ct.a)(),className:"div-shell"},o.a.createElement("div",{className:"div-background"}),o.a.createElement("div",{className:"div-optionBar",style:{width:a[t]/s*100+"%",display:0==a[t]?"none":"inline"}}),o.a.createElement("div",{className:"div-text"},o.a.createElement("p",{className:"p-voteDataShow",style:{left:"0.5em",fontSize:e.length>18?"12px":"14px"}},e),o.a.createElement("p",{className:"p-voteDataShow-right",style:{right:"0.5em",fontSize:a[t]>999?"12px":"14px"}},a[t]),o.a.createElement("span",{className:"liu_area"}))))})):l.map((function(t,n){p.push(o.a.createElement("button",{className:"voteButton",key:n,onClick:function(t){e.sendVoteOption(t.target.innerText)}},t))})),i?o.a.createElement("p",{className:"box box-tip"},"\u6295\u7968\u4e2d\u2026\u2026"):o.a.createElement("div",null,o.a.createElement("hr",null),o.a.createElement("div",{className:"voteGroupPanel"},n?o.a.createElement("div",null,u):o.a.createElement("div",null,p)))}}]),n}(a.PureComponent),Et=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(){return Object(i.a)(this,n),t.apply(this,arguments)}return Object(c.a)(n,[{key:"copy_link",value:function(e){e.preventDefault(),w()("".concat(e.target.href).concat(this.props.info.tag?" \u3010"+this.props.info.tag+"\u3011":"","\n")+"".concat(this.props.info.text).concat("image"===this.props.info.type?" [\u56fe\u7247]":"audio"===this.props.info.type?" [\u8bed\u97f3]":"","\n")+"\uff08".concat(B(new Date(1e3*this.props.info.timestamp))," ").concat(this.props.info.likenum,"\u5173\u6ce8 ").concat(this.props.info.reply,"\u56de\u590d\uff09\n")+"".concat(this.props.info.vote&&this.props.info.vote.vote_options?"\n\u3010\u6295\u7968\u3011\uff1a"+this.props.info.vote.vote_options.map((function(e){return e})).join("\n"):"","\n")+this.props.replies.map((function(e){return(e.tag?"\u3010"+e.tag+"\u3011":"")+"["+e.name+"] "+e.text+("image"===e.type?" [\u56fe\u7247]":"")})).join("\n"))}},{key:"render",value:function(){var e=this.props,t=Object.keys(e.info.vote).length;return o.a.createElement("div",{className:"flow-item"+(e.is_quote?" flow-item-quote":"")},!!e.is_quote&&o.a.createElement("div",{className:"quote-tip black-outline"},o.a.createElement("div",null,o.a.createElement("span",{className:"icon icon-quote"}))),o.a.createElement("div",{className:"box"},window.LATEST_POST_ID&&e.info.pid>window.LATEST_POST_ID?o.a.createElement("div",{className:"flow-item-dot flow-item-dot-post"}):e.info.variant.new_reply?o.a.createElement("div",{className:"flow-item-dot flow-item-dot-comment"}):null,o.a.createElement("div",{className:"box-header"},e.header_badges,o.a.createElement("code",{className:"box-id"},o.a.createElement("a",{href:"##"+e.info.pid,onClick:this.copy_link.bind(this)},"#",e.info.pid)),"\xa0",null!==e.info.tag&&o.a.createElement("span",{className:"box-header-tag"},e.info.tag),o.a.createElement(H,{stamp:e.info.timestamp,short:!e.in_sidebar})),e.info.deleted&&o.a.createElement("p",{key:"deleted-hint",className:"flow-variant-warning"},"\uff08\u5df2\u5220\u9664\uff09"),e.info.variant.report_widget&&e.in_sidebar&&o.a.createElement(bt,{key:"report",info:e.info,is_reply:!1,set_variant:e.set_variant}),o.a.createElement("div",{className:"box-content"},o.a.createElement(ae,{text:e.info.text,color_picker:e.color_picker,search_param:e.search_param,show_pid:e.show_pid}),"image"===e.info.type&&o.a.createElement(ft,{in_sidebar:e.in_sidebar,url:e.info.url})),0!==t&&o.a.createElement(gt,{voteOptions:e.info.vote,pid:e.info.pid,token:this.props.token}),!(!e.attention||!e.info.variant.latest_reply)&&o.a.createElement("p",{className:"box-footer"},"\u6700\u65b0\u56de\u590d"," ",o.a.createElement(H,{stamp:e.info.variant.latest_reply,short:!1}))))}}]),n}(a.PureComponent),wt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={info:e.info,replies:e.replies,loading_status:"done",error_msg:null,filter_name:null,rev:!1},a.color_picker=e.color_picker,a.syncState=e.sync_state||function(){},a.reply_ref=o.a.createRef(),a.reply_to_ref={reply_to:-1},a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){this.props.freshFirst&&this.load_replies()}},{key:"set_variant",value:function(e,t){this.setState((function(n){return e?{replies:n.replies.map((function(n){return n.cid===e?Object.assign({},n,{variant:Object.assign({},n.variant,t)}):n}))}:{info:Object.assign({},n.info,{variant:Object.assign({},n.info.variant,t)})}}),(function(){this.syncState({info:this.state.info,replies:this.state.replies})}))}},{key:"load_replies",value:function(){var e=this;this.setState({loading_status:"loading",error_msg:null}),Le.load_replies(this.state.info.pid,this.props.token,this.color_picker).then((function(t){e.setState({replies:t.data,info:t.post,loading_status:"done",error_msg:null},(function(){e.syncState({replies:t.data,info:t.post}),t.data.length&&e.set_variant(null,{latest_reply:Math.max.apply(null,e.state.replies.map((function(e){return e.timestamp})))})}))})).catch((function(t){console.error(t),e.setState({replies:[],loading_status:"done",error_msg:""+t})}))}},{key:"toggle_attention",value:function(){var e=this;this.setState({loading_status:"loading"});var t=!this.state.info.attention;Le.set_attention(this.state.info.pid,t,this.props.token).then((function(t){t.data.length?t.data.variant={latest_reply:Math.max.apply(null,t.data.map((function(e){return e.timestamp})))}:t.data.variant={},e.setState({loading_status:"done",info:t.data}),e.syncState({info:t.data})})).catch((function(t){e.setState({loading_status:"done"}),alert("\u8bbe\u7f6e\u5173\u6ce8\u5931\u8d25"),console.error(t)}))}},{key:"set_filter_name",value:function(e){this.setState((function(t){return{filter_name:e===t.filter_name?null:e}}))}},{key:"toggle_rev",value:function(){this.setState((function(e){return{rev:!e.rev}}))}},{key:"show_reply_bar",value:function(e,t,n){if(this.reply_to_ref.reply_to=t,this.reply_ref.current&&!n.target.closest("a, .clickable, .interactive")){var a=this.reply_ref.current.get();if(/^\s*(?:Re (?:|\u6d1e\u4e3b|(?:[A-Z][a-z]+ )?(?:[A-Z][a-z]+)|You Win(?: \d+)?):)?\s*$/.test(a)){var o="Re "+e+": ";o===this.reply_ref.current.get()?this.reply_ref.current.set(""):this.reply_ref.current.set(o)}}}},{key:"render_self",value:function(){var e=this;if("loading"===this.state.loading_status)return o.a.createElement("p",{className:"box box-tip"},"\u52a0\u8f7d\u4e2d\u2026\u2026");var t=_t(this.props.show_sidebar,this.props.token),n=this.state.filter_name?this.state.replies.filter((function(t){return t.name===e.state.filter_name})):this.state.replies.slice();this.state.rev&&n.reverse();this.state.rev,this.state.filter_name;var a=Object(m.a)({},"\u6d1e\u4e3b",1);n.forEach((function(e){void 0===a[e.name]&&(a[e.name]=0),a[e.name]++}));var r=this.state.filter_name&&"\u6d1e\u4e3b"!==this.state.filter_name?null:o.a.createElement(ce,{callback:function(t){e.show_reply_bar("",-1,t)}},o.a.createElement(Et,{token:this.props.token,info:this.state.info,in_sidebar:!0,color_picker:this.color_picker,show_pid:t,replies:this.state.replies,set_variant:function(t){e.set_variant(null,t)},header_badges:o.a.createElement(o.a.Fragment,null,this.state.info.permissions.length>0&&(this.state.info.variant.report_widget?o.a.createElement("span",{className:"reply-header-badge clickable",onClick:function(){e.set_variant(null,{report_widget:!1})}},o.a.createElement("span",{className:"icon icon-flag"}),o.a.createElement("label",null,"\u53d6\u6d88")):o.a.createElement("span",{className:"reply-header-badge clickable",onClick:function(){e.set_variant(null,{report_widget:!0})}},o.a.createElement("span",{className:"icon icon-flag"}),o.a.createElement("label",null,this.state.info.permissions.includes("delete")&&!this.state.info.permissions.includes("delete_ban")?"\u64a4\u56de":"\u4e3e\u62a5"))),a["\u6d1e\u4e3b"]>1&&o.a.createElement("span",{className:"reply-header-badge clickable",onClick:function(){e.set_filter_name("\u6d1e\u4e3b")}},o.a.createElement("span",{className:"icon icon-locate"}),o.a.createElement("label",null,"\u53ea\u770b")))}));return o.a.createElement("div",{className:"flow-item-row sidebar-flow-item"},o.a.createElement("div",{className:"box box-tip"},o.a.createElement("a",{onClick:this.load_replies.bind(this)},o.a.createElement("span",{className:"icon icon-refresh"}),o.a.createElement("label",null,"\u5237\u65b0")),(this.state.replies.length>=1||this.state.rev)&&o.a.createElement("span",null,"\xa0\xa0",o.a.createElement("a",{onClick:this.toggle_rev.bind(this)},o.a.createElement("span",{className:"icon icon-order-rev"+(this.state.rev?"-down":"")}),o.a.createElement("label",null,this.state.info.reply," \u56de\u590d"))),"\xa0\xa0",o.a.createElement("a",{onClick:function(){e.toggle_attention()}},o.a.createElement("span",null,o.a.createElement("span",{className:"icon icon-star"+(this.state.info.attention?"-ok":"")}),o.a.createElement("label",null,this.state.info.likenum," \u5173\u6ce8")))),!!this.state.filter_name&&o.a.createElement("div",{className:"box box-tip flow-item filter-name-bar"},o.a.createElement("p",null,o.a.createElement("span",{style:{float:"left"}},o.a.createElement("a",{onClick:function(){e.set_filter_name(null)}},"\u8fd8\u539f")),o.a.createElement("span",{className:"icon icon-locate"}),"\xa0\u5f53\u524d\u53ea\u770b\xa0",o.a.createElement(te,{colors:this.color_picker.get(this.state.filter_name)},this.state.filter_name))),!this.state.rev&&r,!!this.state.error_msg&&o.a.createElement("div",{className:"box box-tip flow-item"},o.a.createElement("p",null,"\u56de\u590d\u52a0\u8f7d\u5931\u8d25"),o.a.createElement("p",null,this.state.error_msg)),n.map((function(n,r){return o.a.createElement(Se,{key:r,offset:1500,height:"5em",overflow:!0,once:!0},o.a.createElement(ce,{callback:function(t){e.show_reply_bar(n.name,n.cid,t)}},o.a.createElement(vt,{info:n,color_picker:e.color_picker,show_pid:t,in_sidebar:!0,set_variant:function(t){e.set_variant(n.cid,t)},header_badges:o.a.createElement(o.a.Fragment,null,n.permissions.length>0&&(n.variant.report_widget?o.a.createElement("span",{className:"reply-header-badge clickable",onClick:function(){e.set_variant(n.cid,{report_widget:!1})}},o.a.createElement("span",{className:"icon icon-flag"}),o.a.createElement("label",null,"\u53d6\u6d88")):o.a.createElement("span",{className:"reply-header-badge clickable",onClick:function(){e.set_variant(n.cid,{report_widget:!0})}},o.a.createElement("span",{className:"icon icon-flag"}))),a[n.name]>1&&o.a.createElement("span",{className:"reply-header-badge clickable",onClick:function(){e.set_filter_name(n.name)}},o.a.createElement("span",{className:"icon icon-locate"})))})))})),this.state.rev&&r,this.props.token?o.a.createElement(it,{pid:this.state.info.pid,token:this.props.token,action:"docomment",area_ref:this.reply_ref,reply_to_ref:this.reply_to_ref,on_complete:this.load_replies.bind(this)}):o.a.createElement("div",{className:"box box-tip flow-item"},"\u767b\u5f55\u540e\u53ef\u4ee5\u56de\u590d\u6811\u6d1e"))}},{key:"render",value:function(){return o.a.createElement(_.a,{mode:"out-in"},o.a.createElement(v.a,{key:this.state.loading_status,timeout:100,classNames:"flows-anim",appear:!0},this.render_self()))}}]),n}(a.PureComponent),yt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).needFold="\u6027\u76f8\u5173,\u653f\u6cbb\u76f8\u5173,NSFW,\u5237\u5c4f,\u5f15\u6218,\u672a\u7ecf\u8bc1\u5b9e\u7684\u4f20\u95fb,\u4ee4\u4eba\u4e0d\u9002,\u91cd\u590d\u5185\u5bb9,\u4e3e\u62a5\u8f83\u591a".split(",").indexOf(e.info.tag)>-1&&("\u70ed\u699c"===e.search_param||!e.search_param)&&!ut.includes(e.search_param)&&window.config.fold&&!e.info.attention,a.state={freshFirst:!1,replies:e.replies||[],reply_status:"done",reply_error:null,info:Object.assign({},e.info,{variant:{}}),hidden:window.config.block_words.some((function(t){return e.info.text.includes(t)}))||a.needFold},a.color_picker=a.props.color_picker||new S,a.pubSubToken=g.a.subscribe("VoteDoneClickFreshSideBarFirst",a.handleFreshForVote.bind(Object(l.a)(a))),a}return Object(c.a)(n,[{key:"handleFreshForVote",value:function(e,t){this.props.info.pid==t&&this.setState({freshFirst:!0})}},{key:"componentWillUnmount",value:function(){g.a.unsubscribe(this.pubSubToken)}},{key:"componentDidMount",value:function(){var e=this;this.state.info.reply&&0===this.state.replies.length&&!this.state.info.comments?this.load_replies(null,!1):this.state.info.comments&&this.setState({replies:this.state.info.comments.map((function(t){return t._display_color=e.color_picker.get(t.name),t})),freshFirst:this.state.info.comments.length!==this.state.info.reply})}},{key:"load_replies",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];console.log("fetching reply",this.state.info.pid),this.setState({reply_status:"loading",reply_error:null}),Le.load_replies_with_cache(this.state.info.pid,this.props.token,this.color_picker,this.state.info.updated_at).then((function(a){t.setState((function(e){return{replies:a.data,info:Object(d.a)(Object(d.a)({},n?a.post:e.info),{},{variant:Object(d.a)(Object(d.a)(Object(d.a)({},e.info.variant||{}),a.post.variant),{},{latest_reply:Math.max.apply(null,a.data.map((function(e){return e.timestamp})))})}),reply_status:"done",reply_error:null}}),e)})).catch((function(n){console.error(n),t.setState({replies:[],reply_status:"failed",reply_error:""+n},e)}))}},{key:"show_sidebar",value:function(e){this.props.show_sidebar("\u6811\u6d1e #"+this.state.info.pid,o.a.createElement(wt,{key:+new Date,info:this.state.info,replies:this.state.replies,sync_state:this.setState.bind(this),token:this.props.token,show_sidebar:this.props.show_sidebar,color_picker:this.color_picker,freshFirst:e}))}},{key:"render",value:function(){var e=this;if(this.state.info.deleted&&dt&&!ut.includes(this.props.search_param))return o.a.createElement(o.a.Fragment,null);var t,n=_t(this.props.show_sidebar,this.props.token,this.state.info.pid),a=[["url",x],["pid",A],["nickname",C]],r=N(this.state.info.text,a),s=null;if(!this.props.is_quote){var i,c=Object(h.a)(r);try{for(c.s();!(i=c.n()).done;){var l=Object(f.a)(i.value,2),u=l[0],p=l[1];if(p=p.length>0?p.substring(1):p,"pid"===u&&-1===ht.indexOf(p)&&(parseInt(p)<parseInt(this.state.info.pid)||ut.includes(this.props.search_param))){if(null!==s){s=null;break}s=parseInt(p)}}}catch(v){c.e(v)}finally{c.f()}}var d=0;if(!this.props.is_quote&&this.props.search_param&&this.props.search_param!==""+this.state.info.pid&&"\u70ed\u699c"!==this.props.search_param&&"#"!==this.props.search_param.charAt(0)){var m=new RegExp("(".concat(this.props.search_param.split(" ").filter((function(e){return!!e})).map(Q).join("|"),")"),"gi");t=this.state.replies.map((function(t){return d>=10?null:m.test(t.text)||t.deleted&&"dels"===e.props.search_param?(d++,o.a.createElement(vt,{key:t.cid,info:t,color_picker:e.color_picker,search_param:e.props.search_param,show_pid:n,header_badges:null,in_sidebar:!1,set_variant:function(e){}})):null})).filter((function(e){return null!==e}))}else d=this.state.replies.length>10?10:this.state.replies.length,t=this.state.replies.slice(0,10).map((function(t){return o.a.createElement(vt,{key:t.cid,info:t,color_picker:e.color_picker,search_param:e.props.search_param,show_pid:n,header_badges:null,in_sidebar:!1,set_variant:function(e){}})}));var _=o.a.createElement("div",{className:"flow-item-row flow-item-row-with-prompt"+(this.props.is_quote?" flow-item-row-quote":""),onClick:function(t){pt[t.target.tagName.toLowerCase()]||(e.state.freshFirst?(e.show_sidebar(!0),e.setState({freshFirst:!1})):e.show_sidebar(!1))}},o.a.createElement(Et,{info:this.state.info,in_sidebar:!1,is_quote:this.props.is_quote,color_picker:this.color_picker,search_param:this.props.search_param,show_pid:n,replies:this.state.replies,set_variant:function(e){},token:this.props.token,header_badges:o.a.createElement(o.a.Fragment,null,!!this.state.info.likenum&&o.a.createElement("span",{className:"box-header-badge"},this.state.info.likenum,"\xa0",o.a.createElement("span",{className:"icon icon-"+(this.state.info.attention?"star-ok":"star")})),!!this.state.info.reply&&o.a.createElement("span",{className:"box-header-badge"},this.state.info.reply,"\xa0",o.a.createElement("span",{className:"icon icon-reply"})))}),o.a.createElement("div",{className:"flow-reply-row"},"loading"===this.state.reply_status&&o.a.createElement("div",{className:"box box-tip"},"\u52a0\u8f7d\u4e2d"),"failed"===this.state.reply_status&&o.a.createElement("div",{className:"box box-tip"},o.a.createElement("p",null,o.a.createElement("a",{onClick:function(){e.load_replies()}},"\u91cd\u65b0\u52a0\u8f7d\u8bc4\u8bba")),o.a.createElement("p",null,this.state.reply_error)),t,this.state.info.reply>d&&o.a.createElement("div",{className:"box box-tip"},"\u8fd8\u6709 ",this.state.info.reply-d," \u6761")));return this.state.hidden?o.a.createElement("div",{className:"flow-item-row flow-item-row-with-prompt",onClick:function(t){pt[t.target.tagName.toLowerCase()]||e.show_sidebar(e.state.freshFirst)}},o.a.createElement("div",{className:"flow-item"+(this.props.is_quote?" flow-item-quote":"")},!!this.props.is_quote&&o.a.createElement("div",{className:"quote-tip black-outline"},o.a.createElement("div",null,o.a.createElement("span",{className:"icon icon-quote"}))),o.a.createElement("div",{className:"box"},o.a.createElement("div",{className:"box-header"},o.a.createElement("code",{className:"box-id"},"#",this.props.info.pid),"\xa0",null!==this.props.info.tag&&o.a.createElement("span",{className:"box-header-tag"},this.props.info.tag),o.a.createElement(H,{stamp:this.props.info.timestamp,short:!0}),o.a.createElement("span",{className:"box-header-badge"},this.needFold?"\u5df2\u9690\u85cf":"\u5df2\u5c4f\u853d"),o.a.createElement("div",{style:{clear:"both"}}))))):s?o.a.createElement("div",null,_,o.a.createElement(kt,{pid:s,show_sidebar:this.props.show_sidebar,token:this.props.token,search_param:this.props.search_param})):_}}]),n}(a.PureComponent),kt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={loading_status:"empty",error_msg:null,info:null},a.color_picker=new S,a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){this.load()}},{key:"load",value:function(){var e=this;this.setState({loading_status:"loading"},(function(){Le.load_replies(e.props.pid,e.props.token,e.color_picker).then((function(t){e.setState({loading_status:"done",info:t})})).catch((function(t){-1!==(""+t).indexOf("\u627e\u4e0d\u5230\u8fd9\u6761\u6811\u6d1e")?e.setState({loading_status:"empty"}):e.setState({loading_status:"error",error_msg:""+t})}))}))}},{key:"render",value:function(){return"empty"===this.state.loading_status?null:"loading"===this.state.loading_status?o.a.createElement("div",{className:"aux-margin"},o.a.createElement("div",{className:"box box-tip"},o.a.createElement("span",{className:"icon icon-loading"}),"\u63d0\u5230\u4e86 #",this.props.pid)):"error"===this.state.loading_status?o.a.createElement("div",{className:"aux-margin"},o.a.createElement("div",{className:"box box-tip"},o.a.createElement("p",null,o.a.createElement("a",{onClick:this.load.bind(this)},"\u91cd\u65b0\u52a0\u8f7d")),o.a.createElement("p",null,this.state.error_msg))):o.a.createElement(yt,{info:this.state.info.post,replies:this.state.info.data,color_picker:this.color_picker,show_sidebar:this.props.show_sidebar,search_param:this.props.search_param,token:this.props.token,is_quote:!0})}}]),n}(a.PureComponent);function Ot(e){return o.a.createElement(nt.Consumer,null,(function(t){var n=t.value;return o.a.createElement("div",{className:"flow-chunk"},!!e.title&&o.a.createElement(W,{text:e.title}),e.list.map((function(t,a){return o.a.createElement(Se,{key:t.pid,offset:500,height:"15em",hiddenIfInvisible:!1},o.a.createElement("div",null,o.a.createElement(yt,{info:t,show_sidebar:e.show_sidebar,token:n,search_param:e.search_param,color_picker:null})))})))}))}var St=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={mode:e.mode,search_param:e.search_text,loaded_pages:0,chunks:{title:"",data:[]},announcement:"",has_update:!1,loading_status:"done",error_msg:null},a.on_scroll_bound=a.on_scroll.bind(Object(l.a)(a)),window.LATEST_POST_ID=parseInt(localStorage._LATEST_POST_ID,10)||0,a}return Object(c.a)(n,[{key:"load_page",value:function(e){var t=this,n=function(e){console.error(e),t.setState((function(t,n){return{loaded_pages:t.loaded_pages-1,loading_status:"failed",error_msg:""+e}}))};if(e>this.state.loaded_pages+1)throw new Error("bad page");if(e===this.state.loaded_pages+1){if("list"===this.state.mode)Le.get_list(e,this.props.token).then((function(n){var a=t.state.announcement,o=t.state.has_update;if(1===e&&n.data.length){var r=-1;if(n.data.forEach((function(e){parseInt(e.pid,10)>r&&(r=parseInt(e.pid,10))})),localStorage._LATEST_POST_ID=""+r,n.config){n.config.announcement&&(a=n.config.announcement);var s=n.config.web_frontend_version.substring(1).split(".");console.log("remote version:",s);var i="v3.0.6".substring(1).split(".");s.length>=3&&(s[0]>i[0]||s[1]-i[1]>0&&s[0]===i[0]||s[0]===i[0]&&s[1]===i[1]&&s[2]-i[2]>0)&&(o=!0,at(s[0]>i[0]||s[1]>i[1]))}}var c=0===n.data.length;n.data.forEach((function(e,t){var a=n.comments[e.pid];a||(a=[]),n.data[t].comments=a,n.data[t].comments.forEach((function(e){e.variant={}}))})),t.setState((function(e,t){return{chunks:{title:"News Feed",data:e.chunks.data.concat(n.data.filter((function(t){return 0===e.chunks.data.length||!e.chunks.data.slice(-100).some((function(e){return e.pid===t.pid}))})))},announcement:a,has_update:o,mode:c?"list_finished":"list",loading_status:"done"}}))})).catch(n);else if("search"===this.state.mode)Le.get_search(e,this.state.search_param,this.props.token).then((function(e){var n=0===e.data.length;e.data.forEach((function(t,n){var a=e.comments[t.pid];a||(a=[]),e.data[n].comments=a,e.data[n].comments.forEach((function(e){e.variant={}}))})),t.setState((function(a,o){return{chunks:{title:'Result for "'+t.state.search_param+'"',data:a.chunks.data.concat(e.data.filter((function(e){return 0===a.chunks.data.length||!a.chunks.data.slice(-100).some((function(t){return t.pid===e.pid}))})))},mode:n?"search_finished":"search",loading_status:"done"}}))})).catch(n);else if("single"===this.state.mode){var a=parseInt(this.state.search_param.substr(1),10);Le.load_replies(a,this.props.token,new S).then((function(e){t.setState({chunks:{title:"PID = "+a,data:[e.post]},mode:"single_finished",loading_status:"done"})})).catch(n)}else{if("attention"!==this.state.mode)return void console.log("nothing to load");!!this.state.search_param?Le.get_search(e,this.state.search_param,this.props.token,!0).then((function(e){var n=0===e.data.length;t.setState((function(a,o){return{chunks:{title:'Result for "'+t.state.search_param+'" in Attention List',data:a.chunks.data.concat(e.data.filter((function(e){return 0===a.chunks.data.length||!a.chunks.data.slice(-100).some((function(t){return t.pid===e.pid}))})))},mode:n?"attention_finished":"attention",loading_status:"done"}}))})).catch(n):Le.get_attention(e,this.props.token).then((function(e){var n=0===e.data.length;t.setState((function(t,a){return{chunks:{title:"Attention List",data:t.chunks.data.concat(e.data.filter((function(e){return 0===t.chunks.data.length||!t.chunks.data.slice(-100).some((function(t){return t.pid===e.pid}))})))},mode:n?"attention_finished":"attention",loading_status:"done"}}))})).catch(n)}this.setState((function(e,t){return{loaded_pages:e.loaded_pages+1,loading_status:"loading",error_msg:null}}))}}},{key:"on_scroll",value:function(e){e.target===document&&(document.body.scrollHeight-window.scrollY-window.innerHeight<window.innerHeight&&"done"===this.state.loading_status&&this.load_page(this.state.loaded_pages+1))}},{key:"componentDidMount",value:function(){this.load_page(1),window.addEventListener("scroll",this.on_scroll_bound),window.addEventListener("resize",this.on_scroll_bound)}},{key:"componentWillUnmount",value:function(){window.removeEventListener("scroll",this.on_scroll_bound),window.removeEventListener("resize",this.on_scroll_bound)}},{key:"render",value:function(){var e=this;dt="on"===localStorage.NOT_SHOW_DELETED;var t=_t(this.props.show_sidebar,this.props.token);return o.a.createElement("div",{className:"flow-container"},this.state.announcement&&this.state.announcement!==localStorage.hide_announcement&&o.a.createElement("div",{className:"box flow-item box-announcement"},o.a.createElement(ae,{text:this.state.announcement,color_picker:this.color_picker,show_pid:t}),o.a.createElement("a",{onClick:function(){localStorage.hide_announcement=e.state.announcement,e.setState({announcement:""})}},"[\u9690\u85cf\u6b64\u516c\u544a]")),this.state.has_update?o.a.createElement("div",{className:"box flow-item box-warning"},o.a.createElement("p",null,"\u68c0\u6d4b\u5230\u66f4\u65b0\uff0c\u6b63\u5728\u66f4\u65b0\u6811\u6d1e..."),o.a.createElement("p",null,o.a.createElement("a",{onClick:at},"[\u5f3a\u5236\u66f4\u65b0]"))):o.a.createElement(Ot,{title:this.state.chunks.title,list:this.state.chunks.data,mode:this.state.mode,search_param:this.state.search_param||null,show_sidebar:this.props.show_sidebar}),"failed"===this.state.loading_status&&o.a.createElement("div",{className:"aux-margin"},o.a.createElement("div",{className:"box box-tip"},o.a.createElement("p",null,o.a.createElement("a",{onClick:function(){e.load_page(e.state.loaded_pages+1)}},"\u91cd\u65b0\u52a0\u8f7d")),o.a.createElement("p",null,this.state.error_msg))),o.a.createElement(W,{text:"loading"===this.state.loading_status?o.a.createElement("span",null,o.a.createElement("span",{className:"icon icon-loading"}),"\xa0Loading..."):"\xa9 cmuhole"}))}}]),n}(a.PureComponent),At=(n(432),/^\/\/setflag ([a-zA-Z0-9_]+)=(.*)$/),Ct=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={search_text:""},a.set_mode=e.set_mode,a.on_change_bound=a.on_change.bind(Object(l.a)(a)),a.on_keypress_bound=a.on_keypress.bind(Object(l.a)(a)),a.do_refresh_bound=a.do_refresh.bind(Object(l.a)(a)),a.do_attention_bound=a.do_attention.bind(Object(l.a)(a)),a.do_hot_posts_bound=a.do_hot_posts.bind(Object(l.a)(a)),a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){var e=this;if(window.location.hash){var t=decodeURIComponent(window.location.hash).substr(1);-1!==t.lastIndexOf("?")&&(t=t.substr(0,t.lastIndexOf("?"))),this.setState({search_text:t},(function(){e.on_keypress({key:"Enter"})}))}}},{key:"on_change",value:function(e){this.setState({search_text:e.target.value})}},{key:"on_keypress",value:function(e){if("Enter"===e.key){var t=At.exec(this.state.search_text);if(t)return void(!0===confirm("Please confirm:\n"+this.state.search_text)&&(t[2]?(localStorage[t[1]]=t[2],alert("Set Flag "+t[1]+"="+t[2]+"\nYou may need to refresh this webpage.")):(delete localStorage[t[1]],alert("Clear Flag "+t[1]+"\nYou may need to refresh this webpage."))));var n=/#[0-9]+/.test(this.state.search_text)?"single":"attention"!==this.props.mode?"search":"attention";this.set_mode(n,this.state.search_text||"")}}},{key:"do_refresh",value:function(){window.scrollTo(0,0),this.setState({search_text:""}),this.set_mode("list",null)}},{key:"do_attention",value:function(){window.scrollTo(0,0),this.setState({search_text:""}),this.set_mode("attention",null)}},{key:"do_hot_posts",value:function(){window.scrollTo(0,0),this.setState({search_text:"\u70ed\u699c"}),this.set_mode("search","\u70ed\u699c")}},{key:"render",value:function(){var e=this;return o.a.createElement(nt.Consumer,null,(function(t){var n=t.value;return o.a.createElement("div",{className:"control-bar"},o.a.createElement("a",{className:"no-underline control-btn",onClick:e.do_refresh_bound},o.a.createElement("span",{className:"icon icon-refresh"}),o.a.createElement("span",{className:"control-btn-label"},"\u6700\u65b0")),!!n&&o.a.createElement("a",{className:"no-underline control-btn",onClick:e.do_attention_bound},o.a.createElement("span",{className:"icon icon-attention"}),o.a.createElement("span",{className:"control-btn-label"},"\u5173\u6ce8")),o.a.createElement("a",{className:"no-underline control-btn",onClick:e.do_hot_posts_bound},o.a.createElement("span",{className:"icon icon-fire"}),o.a.createElement("span",{className:"control-btn-label"},"\u70ed\u699c")),o.a.createElement("input",{className:"control-search",value:e.state.search_text,placeholder:"".concat("attention"===e.props.mode?"\u5728\u5173\u6ce8\u5217\u8868\u4e2d":"","\u641c\u7d22 \u6216 #\u6811\u6d1e\u53f7"),onChange:e.on_change_bound,onKeyPress:e.on_keypress_bound}),o.a.createElement("a",{className:"no-underline control-btn",onClick:function(){e.props.show_sidebar("CMU Anonymous Space",o.a.createElement(ot,{show_sidebar:e.props.show_sidebar}))}},o.a.createElement("span",{className:"icon icon-"+(n?"about":"login")}),o.a.createElement("span",{className:"control-btn-label"},n?"\u8d26\u6237":"\u767b\u5f55")),!!n&&o.a.createElement("a",{className:"no-underline control-btn",onClick:function(){e.props.show_sidebar("\u53d1\u8868\u6811\u6d1e",o.a.createElement(it,{token:n,action:"dopost",pid:"new_post",on_complete:function(){e.props.show_sidebar(null,null,"clear"),e.do_refresh()}}))}},o.a.createElement("span",{className:"icon icon-plus"}),o.a.createElement("span",{className:"control-btn-label"},"\u53d1\u8868")))}))}}]),n}(a.PureComponent);function xt(e){return o.a.createElement("div",{className:"title-bar"},o.a.createElement("div",{className:"aux-margin"},o.a.createElement("div",{className:"title"},o.a.createElement("p",{className:"centered-line"},o.a.createElement("span",{onClick:function(){return e.show_sidebar("CMU Anonymous Space",o.a.createElement(ot,{show_sidebar:e.show_sidebar}))}},"CMU Anonymous Space"))),o.a.createElement(Ct,{show_sidebar:e.show_sidebar,set_mode:e.set_mode,mode:e.mode})))}n(433);var Nt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).do_close_bound=a.do_close.bind(Object(l.a)(a)),a.do_back_bound=a.do_back.bind(Object(l.a)(a)),a}return Object(c.a)(n,[{key:"do_close",value:function(){this.props.show_sidebar(null,null,"clear")}},{key:"do_back",value:function(){this.props.show_sidebar(null,null,"pop")}},{key:"render",value:function(){var e=this,t=this.props.stack.map((function(t,n){var a=t[1];return a&&o.a.createElement("div",{key:n,className:"sidebar-content "+(n===e.props.stack.length-1?"sidebar-content-show":"sidebar-content-hide")},a)})),n=this.props.stack[this.props.stack.length-1][0];return o.a.createElement("div",{className:"sidebar-container "+(null!==n?"sidebar-on":"sidebar-off")},o.a.createElement("div",{className:"sidebar-shadow",onClick:this.do_back_bound,onTouchEnd:function(e){e.preventDefault(),e.target.click()}}),o.a.createElement("div",{className:"sidebar"},t),o.a.createElement("div",{className:"sidebar-title"},o.a.createElement("a",{className:"no-underline",onClick:this.do_close_bound},"\xa0",o.a.createElement("span",{className:"icon icon-close"}),"\xa0"),this.props.stack.length>2&&o.a.createElement("a",{className:"no-underline",onClick:this.do_back_bound},"\xa0",o.a.createElement("span",{className:"icon icon-back"}),"\xa0"),n))}}]),n}(a.PureComponent),jt=n(90),Pt=n.n(jt),Tt=(n(434),function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={level:0,fired:!1},a.callback=e.callback,a.esc_interval=null,a}return Object(c.a)(n,[{key:"do_fire",value:function(){var e=this;this.esc_interval&&(clearInterval(this.esc_interval),this.esc_interval=null),this.setState({level:1,fired:!0}),this.callback(),window.setTimeout((function(){e.setState({level:0,fired:!1})}),300)}},{key:"componentDidMount",value:function(){var e=this;window.config.pressure&&(Pt.a.set(document.body,{change:function(t){e.state.fired||(t>=.999?e.do_fire():e.setState({level:t}))},end:function(){e.setState({level:0,fired:!1})}},{polyfill:!1,only:"touch",preventSelect:!1}),document.addEventListener("keydown",(function(t){t.repeat||"Escape"!==t.key||(e.esc_interval&&clearInterval(e.esc_interval),e.setState({level:.2},(function(){e.esc_interval=setInterval((function(){var t=e.state.level+.1;t>=.999?e.do_fire():e.setState({level:t})}),30)})))})),document.addEventListener("keyup",(function(t){"Escape"===t.key&&(e.esc_interval&&(clearInterval(e.esc_interval),e.esc_interval=null),e.setState({level:0}))})))}},{key:"render",value:function(){var e=25*(this.state.level-.4)-500;return o.a.createElement("div",{className:"pressure-box"+(this.state.fired?" pressure-box-fired":"")+(this.state.level<=1e-4?" pressure-box-empty":""),style:{left:e,right:e,top:e,bottom:e}})}}]),n}(a.Component)),Rt=(n(435),function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={loading_status:"idle",recaptcha_verified:!1,phase:0},a.ref={username:o.a.createRef(),andrew_email:o.a.createRef(),email_verification:o.a.createRef(),password:o.a.createRef(),password_confirm:o.a.createRef(),checkbox_terms:o.a.createRef(),checkbox_account:o.a.createRef()},a.popup_anchor=document.getElementById("pkuhelper_login_popup_anchor"),a.popup_anchor||(a.popup_anchor=document.createElement("div"),a.popup_anchor.id="pkuhelper_login_popup_anchor",document.body.appendChild(a.popup_anchor)),a}return Object(c.a)(n,[{key:"next_step",value:function(){if("loading"!==this.state.loading_status)switch(this.state.phase){case 0:this.do_login(this.props.token_callback);break;case 1:this.verify_email("v3",(function(){}));break;case 2:this.new_user_registration(this.props.token_callback);break;case 3:this.need_recaptcha()}}},{key:"valid_registration",value:function(){return this.ref.checkbox_account.current.checked?this.ref.password.current.value.length<8?(alert("Password too short, should have length at least 8"),2):this.ref.password.current.value!==this.ref.password_confirm.current.value?(alert("Passwords are not the same"),3):0:(alert("Please check to indicate your acknowledgement"),1)}},{key:"sha256",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n,a,o;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(new TextEncoder).encode(t),e.next=3,crypto.subtle.digest("SHA-256",n);case 3:return a=e.sent,o=Array.from(new Uint8Array(a)),e.abrupt("return",o.map((function(e){return("00"+e.toString(16)).slice(-2)})).join(""));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"hashpassword",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sha256(t);case 2:return n=e.sent,e.next=5,this.sha256(n);case 5:return n=e.sent,e.abrupt("return",n);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"verify_email",value:function(e,t){var n=this,a=new URL(location.href).searchParams.get("old_token"),o=this.ref.andrew_email.current.value,r=e,s=localStorage.recaptcha,i=new URLSearchParams;Object.entries({email:o,old_token:a,recaptcha_version:r,recaptcha_token:s}).forEach((function(e){return i.append.apply(i,Object(De.a)(e))})),this.setState({loading_status:"loading"},(function(){fetch(O+"security/login/check_email_invitation?"+U(),{method:"POST",body:i}).then((function(e){return e.json()})).then((function(e){if(e.code<0)throw new Error(e.msg);n.setState({loading_status:"done",phase:e.code}),3===e.code&&t()})).catch((function(e){alert("Fail to validate your email\n"+e),n.setState({loading_status:"done"}),console.error(e)}))}))}},{key:"do_login",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n,a,o,r,s,i=this;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.ref.username.current.value,a=this.ref.password.current.value,e.next=4,this.hashpassword(a);case 4:o=e.sent,r=Fe()(navigator.userAgent).browser.name,s=new URLSearchParams,Object.entries({email:n,password_hashed:o,device_type:0,device_info:r}).forEach((function(e){return s.append.apply(s,Object(De.a)(e))})),this.setState({loading_status:"loading"},(function(){fetch(O+"security/login/login?"+U(),{method:"POST",body:s}).then(D).then((function(e){if(0!==e.code){if(e.msg)throw new Error(e.msg);throw new Error(JSON.stringify(e))}t(e.token),alert("Login Successfully!"),i.setState({loading_status:"done"}),i.props.on_close()})).catch((function(e){console.error(e),alert("Login Failed\n"+e),i.setState({loading_status:"done"})}))}));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"new_user_registration",value:function(){var e=Object(xe.a)(Ce.a.mark((function e(t){var n,a,o,r,s,i,c=this;return Ce.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===this.valid_registration()){e.next=2;break}return e.abrupt("return");case 2:return n=this.ref.username.current.value,a=this.ref.email_verification.current.value,o=this.ref.password.current.value,e.next=7,this.hashpassword(o);case 7:r=e.sent,s=Fe()(navigator.userAgent).browser.name,i=new URLSearchParams,Object.entries({email:n,password_hashed:r,device_type:0,device_info:s,valid_code:a}).forEach((function(e){return i.append.apply(i,Object(De.a)(e))})),this.setState({loading_status:"loading"},(function(){fetch(O+"security/login/create_account_invitation?"+U(),{method:"POST",body:i}).then(D).then((function(e){if(0!==e.code){if(e.msg)throw new Error(e.msg);throw new Error(JSON.stringify(e))}t(e.token),alert("Login Successfully!"),c.setState({loading_status:"done"}),c.props.on_close()})).catch((function(e){console.error(e),alert("Login Failed\n"+e),c.setState({loading_status:"done"})}))}));case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"need_recaptcha",value:function(){console.log(3)}},{key:"render",value:function(){var e=this;return window.recaptchaOptions={useRecaptchaNet:!0},s.a.createPortal(o.a.createElement(F.b,{reCaptchaKey:"6LeXqV4eAAAAAIVICwPAGAGC3UJIHSotqzisoAD8",useRecaptchaNet:!0},o.a.createElement("div",null,o.a.createElement("div",{className:"treehollow-login-popup-shadow"}),o.a.createElement("div",{className:"treehollow-login-popup margin-popup"},0===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("label",null,"Username:\xa0",o.a.createElement("input",{ref:this.ref.username,type:"text",autoFocus:!0}))),o.a.createElement("p",null,o.a.createElement("label",null,"Password:\xa0",o.a.createElement("input",{ref:this.ref.password,type:"password",onKeyDown:function(t){"Enter"===t.key&&e.next_step()}}))),o.a.createElement("p",null,o.a.createElement("a",{onClick:function(){alert("You can delete your account in the sidebar")}},"Forget your password?")),o.a.createElement("p",null,o.a.createElement("button",{onClick:function(){e.setState({phase:1})}},o.a.createElement("b",null,"Sign up")))),1===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("b",null,"Procedures:")),o.a.createElement("p",null,"You will request an invitation code with your CMU email, and use it to sign up an anonymous account."),o.a.createElement("p",null,o.a.createElement("b",null,"Difference between invitation code and verification code:")),o.a.createElement("p",null,"Invitation code is the same for everyone, so when signing up with it, you reveals nothing more than the fact that you have access to a CMU email."),o.a.createElement("p",null,o.a.createElement("b",null,"Best practice:")),o.a.createElement("p",null,"1. After getting the code, you can wait some time."),o.a.createElement("p",null,"2. You can get the code with a device, and then sign up with another device. We are compatible for both phone and computer."),o.a.createElement("p",null,"*Press continue if you have one*")),o.a.createElement("p",{style:1===this.state.phase?{}:{display:"none"}},o.a.createElement("label",null,"Email\xa0",o.a.createElement("input",{ref:this.ref.andrew_email,type:"email",autoFocus:!0,placeholder:"CMU Email Only",onKeyDown:function(t){"Enter"===t.key&&e.next_step()}}))),2===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("b",null,"Sign up")),o.a.createElement("p",null,o.a.createElement("label",null,"Username\xa0",o.a.createElement("input",{ref:this.ref.username,type:"text",autoFocus:!0}))),o.a.createElement("p",null,o.a.createElement("label",null,"Invitation code\xa0",o.a.createElement("input",{ref:this.ref.email_verification,type:"text"}))),o.a.createElement("p",null,o.a.createElement("label",null,"Password\xa0",o.a.createElement("input",{ref:this.ref.password,type:"password"}))),o.a.createElement("p",null,o.a.createElement("label",null,"Password\xa0",o.a.createElement("input",{ref:this.ref.password_confirm,type:"password",onKeyDown:function(t){"Enter"===t.key&&e.next_step()}}))),o.a.createElement("p",null,o.a.createElement("label",null,o.a.createElement("input",{type:"checkbox",ref:this.ref.checkbox_account}),"I understand that I will not be able to get my account back if I forget my password."))),3===this.state.phase&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,o.a.createElement("b",null,"CMU Anonymous Space")),o.a.createElement(It,{callback:function(){e.verify_email("v2",(function(){alert("reCAPTCHA\u98ce\u63a7\u7cfb\u7edf\u6821\u9a8c\u5931\u8d25")}))}},(function(t){return o.a.createElement("p",null,!e.state.recaptcha_verified&&o.a.createElement(F.a,{onVerify:function(n){e.setState({recaptcha_verified:!0}),console.log(n),localStorage.recaptcha=n,e.verify_email("v3",t)}}))}))),o.a.createElement("p",null,o.a.createElement("button",{onClick:this.props.on_close},"Cancel"),o.a.createElement("button",{onClick:this.next_step.bind(this),disabled:"loading"===this.state.loading_status},"Confirm"))))),this.popup_anchor)}}]),n}(a.Component)),Lt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={popup_show:!1},a.on_popup_bound=a.on_popup.bind(Object(l.a)(a)),a.on_close_bound=a.on_close.bind(Object(l.a)(a)),a}return Object(c.a)(n,[{key:"on_popup",value:function(){this.setState({popup_show:!0})}},{key:"on_close",value:function(){this.setState({popup_show:!1})}},{key:"render",value:function(){return o.a.createElement(o.a.Fragment,null,this.props.children(this.on_popup_bound),this.state.popup_show&&o.a.createElement(Rt,{token_callback:this.props.token_callback,on_close:this.on_close_bound}))}}]),n}(a.Component),It=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e,a){var o;return Object(i.a)(this,n),(o=t.call(this,e,a)).onChange=o.onChange.bind(Object(l.a)(o)),o.state={popup_show:!1},o.on_popup_bound=o.on_popup.bind(Object(l.a)(o)),o.on_close_bound=o.on_close.bind(Object(l.a)(o)),o}return Object(c.a)(n,[{key:"on_popup",value:function(){this.setState({popup_show:!0})}},{key:"on_close",value:function(){this.setState({popup_show:!1})}},{key:"componentDidMount",value:function(){this.captchaRef&&(console.log("started, just a second..."),this.captchaRef.reset(),this.captchaRef.execute())}},{key:"onChange",value:function(e){localStorage.recaptcha=e,this.setState({popup_show:!1}),this.props.callback()}},{key:"render",value:function(){var e=this;return o.a.createElement(o.a.Fragment,null,this.props.children(this.on_popup_bound),this.state.popup_show&&o.a.createElement("div",null,o.a.createElement("div",{className:"treehollow-login-popup-shadow"}),o.a.createElement("div",{className:"treehollow-login-alt-popup"},o.a.createElement("div",{className:"g-recaptcha"},o.a.createElement(M.a,{ref:function(t){e.captchaRef=t},sitekey:"6Lcsq14eAAAAALfT0hhnsiIF7te8ikX8S00L6yz1",onChange:this.onChange})),o.a.createElement("p",null,o.a.createElement("button",{onClick:this.on_close_bound},"Cancel")))))}}]),n}(a.Component);n(436);function Dt(e){return o.a.createElement("div",{id:"global-hint-container",style:{display:"none"}})}function Ut(e){return e&&-1!==e.indexOf("\u81ea\u6740")}var Ft=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),a=t.call(this,e),We(),function(e){function t(){(void 0===e?window.matchMedia("(prefers-color-scheme: dark)").matches:e)?document.body.classList.add("root-dark-mode"):document.body.classList.remove("root-dark-mode")}t(),window.matchMedia("(prefers-color-scheme: dark)").addListener((function(){t()}))}({default:void 0,light:!1,dark:!0}[window.config.color_scheme]),a.state={sidebar_stack:[[null,null]],mode:"list",search_text:null,flow_render_key:+new Date,token:localStorage.TOKEN||null,override_suicide:!1},a.show_sidebar_bound=a.show_sidebar.bind(Object(l.a)(a)),a.set_mode_bound=a.set_mode.bind(Object(l.a)(a)),a.on_pressure_bound=a.on_pressure.bind(Object(l.a)(a)),a.inthu_flag=-1!==window[atob("ZG9jdW1lbnQ")][atob("Y29va2ll")].indexOf(atob("dGh1X2lwX2ZsYWc9eWVz")),a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){je()}},{key:"on_pressure",value:function(){this.state.sidebar_stack.length>1?this.show_sidebar(null,null,"clear"):this.set_mode("list",null)}},{key:"show_sidebar",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"push";this.setState((function(a){var o=a.sidebar_stack.slice();if("push"===n)1===o.length&&(document.body.style.top="-".concat(window.scrollY,"px"),document.body.style.position="fixed",document.body.style.width="100vw"),o.length>10&&o.splice(1,1),o=o.concat([[e,t]]);else if("pop"===n){if(1===o.length)return;if(2===o.length){var r=document.body.style.top;document.body.style.position="",document.body.style.top="",document.body.style.width="",window.scrollTo(0,-1*parseInt(r||"0"))}o.pop()}else if("replace"===n)o.pop(),o=o.concat([[e,t]]);else{if("clear"!==n)throw new Error("bad show_sidebar mode");var s=document.body.style.top;document.body.style.position="",document.body.style.top="",document.body.style.width="",window.scrollTo(0,-1*parseInt(s||"0")),o=[[null,null]]}return{sidebar_stack:o}}))}},{key:"set_mode",value:function(e,t){this.setState({mode:e,search_text:t,flow_render_key:+new Date})}},{key:"render",value:function(){var e=this;return o.a.createElement(nt.Provider,{value:{value:this.state.token,set_value:function(t){localStorage.TOKEN=t||"",e.setState({token:t})}}},o.a.createElement(Tt,{callback:this.on_pressure_bound}),o.a.createElement("div",{className:"bg-img",style:qe()}),o.a.createElement(xt,{show_sidebar:this.show_sidebar_bound,set_mode:this.set_mode_bound,mode:this.state.mode}),o.a.createElement(nt.Consumer,null,(function(t){return o.a.createElement("div",{className:"left-container"},o.a.createElement(Dt,{token:t.value}),!t.value&&o.a.createElement("div",{className:"flow-item-row aux-margin"},o.a.createElement("div",{className:"box box-tip"},o.a.createElement("p",null,o.a.createElement(Ve,{token_callback:t.set_value},(function(e){return o.a.createElement("a",{onClick:e},o.a.createElement("span",{className:"icon icon-login"}),"\xa0(Email) Log In / Sign Up")}))))),!t.value&&o.a.createElement("div",{className:"flow-item-row aux-margin"},o.a.createElement("div",{className:"box box-tip"},o.a.createElement("p",null,o.a.createElement(Lt,{token_callback:t.set_value},(function(e){return o.a.createElement("a",{onClick:e},o.a.createElement("span",{className:"icon icon-login"}),"\xa0(Anonymous) Log In / Sign Up")}))))),Ut(e.state.search_text)&&!e.state.override_suicide&&o.a.createElement("div",{className:"flow-item-row"},o.a.createElement("div",{className:"flow-item box box-tip"},o.a.createElement("p",{style:{textAlign:"left"}},"\u9700\u8981\u5e2e\u52a9\uff1f"),o.a.createElement("p",{style:{textAlign:"left"}},"\u5317\u4eac24\u5c0f\u65f6\u5fc3\u7406\u63f4\u52a9\u70ed\u7ebf\uff1a",o.a.createElement("a",{href:"tel:01082951332"},"010-8295-1332")),o.a.createElement("p",{style:{textAlign:"left"}},"\u5e0c\u671b24\u5c0f\u65f6\u70ed\u7ebf\uff1a",o.a.createElement("a",{href:"tel:4001619995"},"400-161-9995")),o.a.createElement("hr",null),o.a.createElement("p",null,o.a.createElement("button",{onClick:function(){window.location.href="https://www.zhihu.com/question/25082178/answer/106073121"}},"\u4e86\u89e3\u66f4\u591a"),"\xa0 \xa0 \xa0",o.a.createElement("button",{onClick:function(){e.setState({override_suicide:!0})}},"\u5c55\u793a\u7ed3\u679c")))),e.inthu_flag||t.value?(e.state.override_suicide||!Ut(e.state.search_text))&&o.a.createElement(_.a,{mode:"out-in"},o.a.createElement(v.a,{key:e.state.flow_render_key,timeout:100,classNames:"flows-anim"},o.a.createElement(St,{key:e.state.flow_render_key,show_sidebar:e.show_sidebar_bound,mode:e.state.mode,search_text:e.state.search_text,token:t.value}))):o.a.createElement(W,{text:"\u8bf7\u767b\u5f55\u540e\u67e5\u770b\u5185\u5bb9"}),o.a.createElement("br",null))})),o.a.createElement(Nt,{show_sidebar:this.show_sidebar_bound,stack:this.state.sidebar_stack}))}}],[{key:"is_darkmode",value:function(){return"dark"===window.config.color_scheme||"light"!==window.config.color_scheme&&window.matchMedia("(prefers-color-scheme: dark)").matches}}]),n}(a.Component),Mt=function(e){Object(u.a)(n,e);var t=Object(p.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={error:null},a}return Object(c.a)(n,[{key:"render",value:function(){return this.state.error?o.a.createElement("div",{style:{margin:"1em",userSelect:"initial"}},o.a.createElement("h1",null,"Frontend Exception"),o.a.createElement("p",null,"Please report this bug to developers."),o.a.createElement("hr",null),o.a.createElement("pre",null,""+this.state.error),o.a.createElement("hr",null),o.a.createElement("pre",null,this.state.error.stack||"(no stack info)")):this.props.children}}],[{key:"getDerivedStateFromError",value:function(e){return console.log(e),{error:e}}}]),n}(a.Component),Vt=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function Bt(e){navigator.serviceWorker.register(e).then((function(e){e.onupdatefound=function(){var t=e.installing;t.onstatechange=function(){"installed"===t.state&&(navigator.serviceWorker.controller?console.log("New content is available; please refresh."):console.log("Content is cached for offline use."))}}})).catch((function(e){console.error("Error during service worker registration:",e)}))}s.a.render(o.a.createElement(Mt,null,o.a.createElement(Ft,null)),document.getElementById("root")),"serviceWorker"in navigator&&window.addEventListener("load",(function(){var e="".concat(".","/service-worker.js");Vt?(function(e){fetch(e).then((function(t){404===t.status||-1===t.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then((function(e){e.unregister().then((function(){window.location.reload()}))})):Bt(e)})).catch((function(){console.log("No internet connection found. App is running in offline mode.")}))}(e),navigator.serviceWorker.ready.then((function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")}))):Bt(e)}))},45:function(e,t,n){},93:function(e,t,n){e.exports=n(437)},98:function(e,t,n){}},[[93,1,2]]]);
//# sourceMappingURL=main.553eab10.chunk.js.map